!function(){"use strict";class e{static get SHIFT_A(){return"Alt+Shift+A"}static get SHIFT_R(){return"Alt+Shift+R"}static get SHIFT_T(){return"Alt+Shift+T"}static get SHIFT_O(){return"Alt+Shift+O"}static get SHIFT_E(){return"Alt+Shift+E"}static get SHIFT_N(){return"Alt+Shift+N"}static get SHIFT_P(){return"Alt+Shift+P"}static get SHIFT_L(){return"Alt+Shift+L"}static get SHIFT_S(){return"Alt+Shift+S"}static get SHIFT_BACK(){return"Alt+Shift+,"}static get UP_ARROW(){return 38}static get DOWN_ARROW(){return 40}static get CMD_RUN_QUERY(){return"cmd.run-query"}static get CMD_RUN_ALL(){return"cmd.run-all"}static get CMD_FORMAT_QUERY(){return"cmd.format-query"}static get CMD_EXPORT(){return"cmd.export"}static get CMD_CLEAR_FILTER(){return"cmd.clear-filter"}static get CMD_NEXT_ROWS(){return"cmd.next-rows"}static get CMD_PREV_ROWS(){return"cmd.prev-rows"}static get CMD_FORMAT_QUERY(){return"cmd.format-query"}static get CMD_EXPORT_TABLE(){return"cmd.export-table"}static get CMD_SEARCH_TABLES(){return"cmd.search-tables"}static get CMD_BACK(){return"cmd.back"}static get GRID_HAS_FOCUS(){return"grid-has-focus"}static get SEARCH_BAR_HAS_FOCUS(){return"search-bar-has-focus"}static get DB_RENAMED(){return"db-menu.db-renamed"}static get DB_DELETED(){return"db-menu.db-deleted"}static get TABLE_RENAMED(){return"ops-menu.table-renamed"}static get TABLE_TRUNCATED(){return"ops-menu.table-truncated"}static get ROW_SELECTED(){return"table-utils.row-selected"}static get ROW_DELETED(){return"row-deleter.row-deleted"}static get COLUMNS_SELECTED(){return"cmd.columns-selected"}static get STREAM_ERROR(){return"stream.stream-error"}static get SORT_REQUESTED(){return"table-utils.sort-requested"}static get QUERY_CANCELLED(){return"table-utils.query-cancelled"}static get TABLE_SELECTED(){return"tables.table-selected"}static get TABLE_UNSELECTED(){return"tables.table-unselected"}static get CELL_EDITED(){return"tables.cell-edited"}static get TABLE_CHANGED(){return"table-contents.table-changed"}static get DB_CHANGED(){return"appbar.db-changed"}static get GRID_H_RESIZED(){return"gridh.resized"}static get QUERY_DISPATCHED(){return"query-dispatched"}static get FILE_UPLOADED(){return"file-uploaded"}static get QUERY_SAVED(){return"query-saved"}static get CONNECTION_SAVED(){return"connection-saved"}static get CONNECTION_DELETED(){return"connection-deleted"}static get QUERY_UPDATED(){return"query-updated"}static get SESSION_ID(){return"session-id"}static get URL(){return"http://localhost:23890"}static get WS_URL(){return"ws://localhost:23890"}static get DB_NAME(){return"prosql"}static get DB_VERSION(){return 1}static get CONNECTIONS(){return"connections"}static get COLUMN_SELECTIONS(){return"column-selections"}static get BATCH_SIZE(){return 1e3}static get BATCH_SIZE_WS(){return 1e3}static get CREDS(){return"creds"}static get SYSTEM(){return"system"}static get USER(){return"user"}static get DB_ID_INDEX(){return"db-id-index"}static get CONNECTIONS_META_KEY(){return 1}static get QUERIES_META_KEY(){return 2}static get CONNECTIONS_META_DB_VERSION(){return 1}static get QUERIES_META_DB_VERSION(){return 1}static get QUERY_DB_VERSION(){return 39}static get CONN_DB_VERSION(){return 4}static get INIT_PROGRESS(){return"init-progress"}static get START_PROGRESS(){return"start-progress"}static get STOP_PROGRESS(){return"stop-progress"}static get UPDATE_PROGRESS(){return"update-progress"}static get DEBUG_LOG(){return"worker.debug-log"}static get SIGNIN_REQUIRED(){return"worker.signin-required"}static get NEW_CONNECTIONS(){return"worker.new-connection"}static get NEW_QUERIES(){return"worker.new-queries"}static get EXECUTE_SAVE_REC(){return"worker.execute-save-rec"}static get EXECUTE_SUCCESS(){return"app.execute-success"}static get EXECUTE_ERROR(){return"app.execute-error"}static get STATUS_ACTIVE(){return"active"}static get STATUS_DELETED(){return"deleted"}static get EDITOR_TEXT_CHANGED(){return"editor-text-changed"}static get EPOCH_TIMESTAMP(){return"2021-01-01T00:00:00Z"}static get LAST_SYNC_TS(){return"last-sync-ts"}static get CURRENT_PAGE(){return"current-page"}}const t=["grid-resizer","cell-renderer","table-utils","query-worker","connection-worker","query-db"];class s{constructor(e=null){this.port=e}log(r,i){t.includes(r)||(this.port?this.port.postMessage({type:e.DEBUG_LOG,payload:`${r}: ${i}`}):s.print(r,i))}static Log(e,r){t.includes(e)||s.print(e,r)}static print(e,t){let[s,r,i]=(new Date).toLocaleDateString("en-US").split("/"),[n,a,o]=(new Date).toLocaleTimeString("en-US").split(/:| /),l=`${r}-${s}-${i} ${n}:${a}:${o}:::${e}: ${t}`;console.log(l)}}class r{static get ERR_NONE(){return"none"}static get ERR_NO_AGENT(){return"no-agent"}static get ERR_INVALID_USER_INPUT(){return"invalid-user-input"}static get ERR_INVALID_SESSION_ID(){return"invalid-session-id"}static get ERR_SIGNIN_REQUIRED(){return"signin-required"}static get ERR_INVALID_CURSOR_ID(){return"invalid-cursor-id"}static get ERR_DB_ERROR(){return"db-error"}static get ERR_UNRECOVERABLE(){return"unrecoverable-error"}static handle(e){e.error!=r.ERR_NO_AGENT?e.error!=r.ERR_INVALID_SESSION_ID?alert(e.error):window.location="/connections":window.location="/install"}}const i="base-db";class n{constructor(e,t){this.logger=e,this.version=t.version,this.dbName=t.dbName}async open(){return new Promise(((e,t)=>{let s=indexedDB.open(this.dbName,this.version);s.onsuccess=t=>{this.logger.log(i,"open.onsuccess"),this.db=s.result,e(0)},s.onerror=e=>{this.logger.log(i,e.target.error),t(e.target.errorCode)},s.onupgradeneeded=e=>{this.onUpgrade(e)}}))}async save(e,t){return new Promise(((s,r)=>{let n=this.db.transaction([e],"readwrite").objectStore(e).add(t);n.onsuccess=e=>{s(e.target.result)},n.onerror=e=>{this.logger.log(i,e.target.error),s(-1)}}))}async put(e,t){return new Promise(((s,r)=>{let n=this.db.transaction([e],"readwrite").objectStore(e);t.updated_at=new Date;let a=n.put(t);a.onsuccess=e=>{s(0)},a.onerror=e=>{this.logger.log(i,e.target.error),s(-1)}}))}async destroy(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.store,"readwrite").objectStore(this.store).delete(e);r.onsuccess=e=>{t(0)},r.onerror=e=>{t(e.target.error)}}))}async del(t){return new Promise(((s,r)=>{let i=this.db.transaction(this.store,"readwrite").objectStore(this.store),n=i.get(t);n.onsuccess=t=>{let r=t.target.result;r.status=e.STATUS_DELETED;let n=i.put(r);n.onerror=e=>{s(e.target.error)},n.onsuccess=e=>{s(0)}},n.onerror=e=>{s(e.target.error)}}))}async get(e,t=[]){return new Promise(((s,r)=>{let n=this.db.transaction(this.store).objectStore(this.store).get(e);n.onsuccess=e=>{let r=[];if(t.length>0)for(let e in n.result)t.includes(e)&&(r[e]=n.result[e]);else r=n.result;this.logger.log(i,JSON.stringify(r)),s(r)},n.onerror=e=>{s(null)}}))}async getAll(e=[]){return new Promise(((t,s)=>{let r=this.db.transaction(this.store).objectStore(this.store),i=[];r.openCursor().onsuccess=s=>{var r=s.target.result;if(r){if(e.length>0){let t={};for(let s in r.value)e.includes(s)&&(t[s]=r.value[s]);i.push(t)}else i.push(r.value);r.continue()}else t(i)}}))}async reset(t){return new Promise(((s,r)=>{let i=this.db.transaction(this.store,"readwrite").objectStore(this.store),n=i.get(t.id);n.onsuccess=t=>{let r=t.target.result;r.db_id=null,r.synced_at=new Date(e.EPOCH_TIMESTAMP);let n=i.put(r);n.onerror=e=>{s(e.target.error)},n.onsuccess=e=>{s(0)}},n.onerror=e=>{s(e.target.error)}}))}async sync(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.store,"readwrite").objectStore(this.store),i=r.get(e.id);i.onsuccess=s=>{let i=s.target.result;i.db_id=e.db_id,i.synced_at=new Date;let n=r.put(i);n.onerror=e=>{t(e.target.error)},n.onsuccess=e=>{t(0)}},i.onerror=e=>{t(e.target.error)}}))}async findByDbId(t){return new Promise(((s,r)=>{this.logger.log(i,"findByDbId");let n=this.db.transaction(this.store).objectStore(this.store).index(e.DB_ID_INDEX).get(IDBKeyRange.only([t]));n.onsuccess=e=>{s(n.result)},n.onerror=e=>{this.logger.log(i,"error"),s(e.target.error)}}))}static toDb(e={}){let t={};for(let s in e)t[s.replaceAll(/-/g,"_")]=e[s];return t}static toDbArray(e=[]){let t=[];return e.forEach((e=>{t.push(e.replaceAll(/-/g,"_"))})),t}static fromDbArray(e=[]){let t=[];return e.forEach((e=>{let s={};for(let t in e)s[t.replaceAll(/_/g,"-")]=e[t];t.push(s)})),t}static fromDb(e={}){let t={};for(let s in e)t[s.replaceAll(/_/g,"-")]=e[s];return t}}const a="query-db",o="created-at-index",l="term-index",d="tag-index";class c extends n{constructor(e,t){t.dbName="queries",super(e,t),this.logger=e,this.store="queries",this.searchIndex="search-index",this.tagIndex="tag-index"}onUpgrade(t){if(this.logger.log(a,`onUpgrade: o: ${t.oldVersion} n: ${t.newVersion}`),t.oldVersion<2){let e=t.target.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0});e.createIndex(o,"created_at",{unique:!1}),e=t.target.result.createObjectStore(this.searchIndex,{keyPath:"id",autoIncrement:!0}),e.createIndex(l,"term",{unique:!0}),e=t.target.result.createObjectStore(this.tagIndex,{keyPath:"id",autoIncrement:!0}),e.createIndex(d,"tag",{unique:!0})}if(t.oldVersion<37){t.currentTarget.transaction.objectStore(this.store).createIndex(e.DB_ID_INDEX,["db_id"])}}async save(e){return new Promise((async(t,s)=>{e.query=e.query.replace(/[ ]{2,}/g," "),this.logger.log(a,JSON.stringify(e.terms));let r=-1;try{if(e.created_at||(e.created_at=new Date),r=await super.save(this.store,e),-1==r)return void t(-1);await this.updateSearchIndex(r,e.terms),await this.updateTagIndex(r,e.tags),t(r)}catch(e){this.logger.log(a,`error: ${JSON.stringify(e.message)}`),s(e.message)}}))}async updateSearchIndex(e,t){for(let s=0;s<t.length;s++){let r=t[s];if(r=r.trim(),!(r.length<=1)){r=this.cleanup(r);try{let t=await this.findByTerm(r);if(null==t){await super.save(this.searchIndex,{term:r,queries:[e]});continue}t.queries.push(e),this.logger.log(a,JSON.stringify(t)),super.put(this.searchIndex,{id:t.id,term:r,queries:t.queries})}catch(e){this.logger.log(a,"error: e.message")}}}}async findByTerm(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.searchIndex).objectStore(this.searchIndex).index(l),i=IDBKeyRange.only(e);r.openCursor(i).onsuccess=e=>{let s=e.target.result;if(s)return this.logger.log(a,JSON.stringify(s.value)),void t(s.value);t(null)}}))}async updateTagIndex(e,t){for(let s=0;s<t.length;s++){let r=t[s];if(r=r.trim(),!(r.length<=1)){r=this.cleanup(r);try{let t=await this.findByTag(r);if(null==t){await super.save(this.tagIndex,{tag:r,queries:[e]});continue}t.queries.push(e),this.logger.log(a,JSON.stringify(t)),super.put(this.tagIndex,{id:t.id,tag:r,queries:t.queries})}catch(e){this.logger.log(a,"error: e.message")}}}}async findByTag(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.tagIndex).objectStore(this.tagIndex).index(d),i=IDBKeyRange.only(e);r.openCursor(i).onsuccess=e=>{let s=e.target.result;if(s)return this.logger.log(a,JSON.stringify(s.value)),void t(s.value);t(null)}}))}async findByQuery(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.dbName).objectStore(this.store).index("query-index"),i=IDBKeyRange.only(e);r.openCursor(i).onsuccess=e=>{let s=e.target.result;if(s)return this.logger.log(a,JSON.stringify(s.value)),void t(s.value);t([])}}))}cleanup(e){let t=["`","`"," ",'"',"'",",",";","+","-","=","!=","<",">",">=","<="],s=0,r=(e=e.replace(/^\S+\./,"")).length;for(;s<r&&t.indexOf(e[s])>=0;)++s;for(;r>s&&t.indexOf(e[r-1])>=0;)--r;return s>0||r<e.length?e.substring(s,r):e}async filter(e,t,s){let r,i;this.logger.log(a,`filter: days ${JSON.stringify(e)} tags ${t} terms ${s}`),e.hasOwnProperty("start")&&(r=new Date(Date.now()-24*e.start*60*60*1e3),r.setHours(0),r.setMinutes(0),r.setSeconds(0)),e.hasOwnProperty("end")&&(i=new Date(Date.now()-24*e.end*60*60*1e3),i.setHours(23),i.setMinutes(59),i.setSeconds(59));let n=[];if((r||i)&&(this.logger.log(a,"filtering"),n=await this.searchByCreatedAt(r,i),0==n.length))return[];if(t.length>0){let e=await this.searchByTags(t);if(n=n.filter((t=>e.includes(t))),0==n.length)return[]}if(s.length>0){let e=await this.searchByTerms(s);if(n=n.filter((t=>e.includes(t))),0==n.length)return[]}let o=[];this.logger.log(a,`${n}`);for(let e=0;e<n.length;e++)o.push(await super.get(n[e]));return o}async findByIds(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.store).objectStore(this.store),i=[];r.openCursor(null,"prev").onsuccess=s=>{let r=s.target.result;r?(e.includes(r.value.id)&&i.push(r.value),r.continue()):t(i)}}))}async updateTags(e){await super.put(this.store,e),await this.updateTagIndex(e.id,e.tags)}searchByTerms(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.searchIndex).objectStore(this.searchIndex),i=[];r.openCursor().onsuccess=s=>{let r=s.target.result;r?(e.includes(r.value.term)&&(i=i.concat(r.value.queries)),r.continue()):t(i)}}))}searchByTags(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.tagIndex).objectStore(this.tagIndex),i=[];r.openCursor().onsuccess=s=>{let r=s.target.result;r?(e.includes(r.value.tag)&&(i=i.concat(r.value.queries)),r.continue()):t(i)}}))}listTags(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.tagIndex).objectStore(this.tagIndex).index(d),i=[];IDBKeyRange.lowerBound(e),r.openCursor().onsuccess=e=>{let s=e.target.result;s?(i.push(s.value.tag),s.continue()):t(i)}}))}listTerms(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.searchIndex).objectStore(this.searchIndex).index(l),i=[];IDBKeyRange.lowerBound(e),r.openCursor().onsuccess=e=>{let s=e.target.result;s?(i.push(s.value.term),s.continue()):t(i)}}))}searchByCreatedAt(e,t){return new Promise(((s,r)=>{this.logger.log(a,`s: ${e} e: ${t}`);let i,n=this.db.transaction(this.store).objectStore(this.store).index(o);if(e&&t)i=IDBKeyRange.bound(e,t);else if(e)i=IDBKeyRange.lowerBound(e);else{if(!t)return void s([]);i=IDBKeyRange.upperBound(t)}let l=[];n.openCursor(i,"prev").onsuccess=e=>{let t=e.target.result;t?(this.logger.log(a,`id: ${t.value.created_at.toISOString()}`),l.push(t.value.id),t.continue()):s(l)}}))}}class u extends n{async getDb(){let e=await super.get(parseInt(1));return null==e?"":e.db??""}async setDb(e){this.logger.log("base-meta-db","setDb");let t=await super.get(parseInt(1));null!=t?(t.db=e,await this.put(this.store,t)):await this.save(this.store,{id:parseInt(1),db:e})}async getLastSyncTs(){let t=await super.get(parseInt(1));return null==t?new Date(e.EPOCH_TIMESTAMP):t.last_sync_ts??new Date(e.EPOCH_TIMESTAMP)}async setLastSyncTs(){let e=await super.get(parseInt(1));null!=e?(e.last_sync_ts=new Date,await super.put(this.store,e)):await super.save(this.store,{id:parseInt(1),last_sync_ts:new Date})}async get(){return await super.get(parseInt(1))}async destroy(){return await super.destroy(parseInt(1))}}class h extends u{constructor(e,t){t.dbName="queries_meta",super(e,t),this.logger=e,this.store="queries_meta"}onUpgrade(e){this.logger.log("queries-meta-db",`onUpgrade: o: ${e.oldVersion} n: ${e.newVersion}`),e.oldVersion<1&&e.target.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0})}}const g="connection-db",m="connection-index";class p extends n{constructor(e,t){t.dbName="connections",super(e,t),this.logger=e,this.store="connections"}onUpgrade(t){if(this.logger.log(g,`open.onupgradeneeded: ${t.oldVersion}`),t.oldVersion<1){t.currentTarget.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0}).createIndex(m,["name","user","pass","port","db"],{unique:!0})}if(t.oldVersion<2){t.currentTarget.transaction.objectStore(this.store).createIndex(e.DB_ID_INDEX,["id","db_id"],{unique:!0})}if(t.oldVersion<3){let s=t.currentTarget.transaction.objectStore(this.store);s.deleteIndex(m),s.deleteIndex(e.DB_ID_INDEX),s.createIndex(m,["name","user","port","db"],{unique:!0}),s.createIndex(e.DB_ID_INDEX,["db_id"],{unique:!0})}if(t.oldVersion<4){let e=t.currentTarget.transaction.objectStore(this.store);e.deleteIndex(m),e.createIndex(m,["name","user","host","port","db"],{unique:!0})}}async save(e){try{if(1==e.is_default){let e=await super.getAll();for(let t=0;t<e.length;t++)await this.put(e[t].id,e[t].pass,!1)}let t=await this.search(e);return t?(await this.put(t.id,e.pass,e.is_default),t.id):await super.save(this.store,e)}catch(e){this.logger.log(g,e.message)}}async put(e,t,s){return new Promise(((r,i)=>{let n=this.db.transaction(this.store,"readwrite").objectStore(this.store),a=n.get(e);a.onsuccess=e=>{let i=e.target.result;t&&(i.pass=t),i.is_default!=s&&(i.updated_at=new Date),i.is_default=s;let a=n.put(i);a.onerror=e=>{r(e.target.error)},a.onsuccess=e=>{r(0)}},a.onerror=e=>{r(e.target.error)}}))}async search(e){return new Promise(((t,s)=>{let r=this.db.transaction(this.store).objectStore(this.store).index(m).get(IDBKeyRange.only([e.name,e.user,e.host,e.port,e.db]));r.onsuccess=e=>{t(r.result)},r.onerror=e=>{t(e.target.error)}}))}}class E extends u{constructor(e,t){t.dbName="connections_meta",super(e,t),this.logger=e,this.store="connections_meta"}onUpgrade(e){this.logger.log("connections-meta-db",`onUpgrade: o: ${e.oldVersion} n: ${e.newVersion}`),e.oldVersion<1&&e.target.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0})}}const y="utils";class b{static saveToSession(e,t){window.sessionStorage.setItem(e,t)}static getFromSession(e){return window.sessionStorage.getItem(e)}static removeFromSession(e){window.sessionStorage.removeItem(e)}static saveToLocalStorage(e,t){window.localStorage.setItem(e,t)}static getFromLocalStorage(e){return window.localStorage.getItem(e)??null}static removeFromLocalStorage(e){window.localStorage.removeItem(e)}static processTemplate(e,t){var s=new RegExp(/{(.*?)}/g);return e=e.replace(s,(function(e,s){return t[s]||0==t[s]||""==t[s]?t[s]:e}))}static generateNode(e,t){e=b.processTemplate(e,t);let s=document.createElement("template");return s.innerHTML=e.trim(),s.content}static async get(e,t=!0,i={}){try{let t={"X-Request-ID":b.uuid()};t={...t,...i};let r=await fetch(e,{headers:t}),n=await r.json();if(s.Log(y,JSON.stringify(n)),"error"==n.status)throw n;return n}catch(e){s.Log(y,JSON.stringify(e));let i={status:"error",data:null};if(e instanceof TypeError)return t?void(window.location="/install"):(i.msg=r.ERR_NO_AGENT,i);if(i.msg=e.msg,i.msg==r.ERR_INVALID_SESSION_ID)return void(window.location="/connections");if(!t)return i;if(i.msg==r.ERR_INVALID_CURSOR_ID)return i;if(i.msg)return alert(i.msg),i}}static async post(e,t,i=!0,n={}){try{let r={"X-Request-ID":b.uuid()};r={...r,...n};let i=new FormData;for(let e in t)i.append(e,t[e]);let a=await fetch(e,{headers:r,body:i,method:"post"}),o=await a.json();if(s.Log(y,JSON.stringify(o)),"error"==o.status)throw o;return o}catch(e){s.Log(y,JSON.stringify(e));let t={status:"error",data:null};if(e instanceof TypeError)return i?void(window.location="/install"):(t.msg=r.ERR_NO_AGENT,t);if(t.msg=e.msg,t.msg==r.ERR_SIGNIN_REQUIRED)return void(window.location="/signin");if(!i)return t;if(t.msg==r.ERR_INVALID_CURSOR_ID)return t;if(t.msg)return alert(t.msg),t}}static async setOptions(e,t,s){e.replaceChildren();let r=document.getElementById("option-template").innerHTML;t.forEach((t=>{let s=b.generateNode(r,{value:t});e.append(s)})),e.value=s}static showAlert(e,t){let s=document.getElementById("alert");s.querySelector(".msg").innerHTML=e,s.style.display="block";let r=document.querySelector("body").getBoundingClientRect();s.style.left=r.width/2+"px",setTimeout((()=>{s.style.display="none"}),t)}static showNoData(){s.Log(y,"No data")}static uuid(){return"_"+Math.random().toString(36).substr(2,9)}static getOffset(e){const t=e.getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY,width:t.width,height:t.height}}static extractColumns(e){let t=[];return e.forEach((e=>{t.push(e[1])})),t}static truncate(e,t){return e.length>t?e.substring(0,t)+"...":e}static getTimestamp(){return(new Date).toISOString().replace(/T/," ").replace(/\..*$/,"")}static getRandomIntegerInclusive(e,t){return Math.floor(Math.random()*(t-e+1))+e}static isEmpty(e){for(var t in e)return!1;return!0}static async resetAll(){let t=new p(new s,{version:e.CONN_DB_VERSION});await t.open();let r=await t.getAll();s.Log(y,"Resetting connections..");for(let e=0;e<r.length;e++)await t.reset(r[e]);s.Log(y,"Done.");let i=new c(new s,{version:e.QUERY_DB_VERSION});await i.open();let n=await i.getAll();s.Log(y,"Resetting queries..");for(let e=0;e<n.length;e++)await i.reset(n[e]);s.Log(y,"Done."),s.Log(y,"Resetting QueriesMetaDB");let a=new h(new s,{version:e.QUERIES_META_DB_VERSION});await a.open(),await a.destroy(),s.Log(y,"Done."),s.Log(y,"Resetting connectionsMetaDb");let o=new E(new s,{version:e.CONNECTIONS_META_DB_VERSION});await o.open(),await o.destroy(),s.Log(y,"Done.")}static async delay(e){return new Promise(((t,s)=>{setTimeout((()=>{t()}),e)}))}static getTerms(e){let t=[],r=sqlFormatter.format(e,{language:"mysql"}).tokens;return s.Log(y,JSON.stringify(r)),r.forEach((e=>{"string"!=e.type&&"word"!=e.type&&"number"!=e.type?/^reserved/.test(e.type)&&t.push(e.value):t.push(e.value)})),t}}const S="stream";class w{constructor(e){this.promises=[],this.registered=!1,this.ws=new WebSocket(e),this.ws.onerror=e=>{s.Log(S,"onerror:"+e),this.rej(r.ERR_NO_AGENT)},this.ws.onclose=e=>{s.Log(S,"onclose"),this.ws=null}}get(){return new Promise(((e,t)=>{this.registered||(this.ws.onmessage=e=>{let t=this.promises.shift(),s=JSON.parse(e.data);"error"!=s.status?t(s.k):this.rej(s.msg)},this.registered=!0),this.promises.push(e),this.rej=t}))}}let R={};class f{static subscribe(e,t){R[e]||(R[e]=new Set),R[e].add(t)}static publish(e,t){let s=R[e];if(s)for(let e of s)e(t)}}let _=new class{constructor(t={}){document.addEventListener("DOMContentLoaded",(()=>{this.progressBar=document.getElementById("progress-bar-no-buttons"),this.message=this.progressBar.querySelector(".message"),this.time=this.progressBar.querySelector(".time"),this.hasButtons=!1})),f.subscribe(e.INIT_PROGRESS,(e=>{this.time.innerHTML="",this.message.innerHTML="",this.elapsed=0,this.hasButtons&&(this.title.innerHTML=e.title),this.message.innerHTML=e.message,this.timer=setInterval((()=>{this.elapsed++,this.time.innerHTML=this.elapsed+" s"}),1e3),this.progressBar.classList.add("is-active")})),f.subscribe(e.START_PROGRESS,(e=>{this.time.innerHTML="",this.message.innerHTML="",this.elapsed=0,this.hasButtons&&(this.title.innerHTML=e.title)})),f.subscribe(e.STOP_PROGRESS,(()=>{if(clearInterval(this.timer),this.ok)return this.ok.disabled=!1,void(this.cancel.disabled=!0);this.progressBar.classList.remove("is-active")})),f.subscribe(e.UPDATE_PROGRESS,(e=>{this.message.innerHTML=e.message})),document.addEventListener("click",(e=>{if(!e.target.classList.contains("copy-filename"))return;let t=e.target.dataset.filename;navigator.clipboard.writeText(t).then((()=>{b.showAlert("Copied",500)}))}))}setOptions(e){e.buttons?(this.progressBar=document.getElementById("progress-bar-with-buttons"),this.title=this.progressBar.querySelector(".modal-card-title"),this.ok=this.progressBar.querySelector(".ok"),this.cancel=this.progressBar.querySelector(".cancel"),this.cancelFunc=e.cancel,this.ok.disabled=!0,this.cancel.disabled=!1,this.ok.addEventListener("click",(()=>{this.progressBar.classList.remove("is-active")})),this.cancel.addEventListener("click",(()=>{this.cancelFunc(),this.progressBar.classList.remove("is-active")})),this.hasButtons=!0):(this.ok=null,this.cancel=null,this.cancelFunc=null,this.progressBar=document.getElementById("progress-bar-no-buttons"),this.hasButtons=!1),this.message=this.progressBar.querySelector(".message"),this.time=this.progressBar.querySelector(".time")}};const I="dbutils";class D{static async fetchAll(t,r,i=!1){let n={"session-id":t,query:r},a=await b.get(e.URL+"/query?"+new URLSearchParams(n),i);if(s.Log(I,JSON.stringify(a)),"error"==a.status)throw s.Log(I,JSON.stringify(a)),a.msg;n={"session-id":t,"cursor-id":a.data["cursor-id"],"num-of-rows":e.BATCH_SIZE};let o=!1,l=[];do{if(a=await b.get(e.URL+"/fetch?"+new URLSearchParams(n),i),"error"==a.status)throw s.Log(I,JSON.stringify(a)),a.msg;if(s.Log(I,JSON.stringify(a)),!a.data)return l;l=l.concat(a.data),o=a.eof}while(!o);return l}static async login(t){let r=await b.get(e.URL+"/login?"+new URLSearchParams(t));return"error"==r.status?(s.Log(I,JSON.stringify(r)),""):r.data["session-id"]}async execute(t){this.cursorId=await D.fetchCursorId(this.sessionId,t,!0);let s={"session-id":this.sessionId,"cursor-id":this.cursorId,"num-of-rows":-1};return await b.get(e.URL+"/fetch?"+new URLSearchParams(s))}static async cancel(t,s){let r={"session-id":t,"cursor-id":s};await b.get(e.URL+"/cancel?"+new URLSearchParams(r))}static async fetchCursorId(t,s,r=!1){let i={"session-id":t,query:encodeURIComponent(s)};if(r){return(await b.get(e.URL+"/execute?"+new URLSearchParams(i))).data["cursor-id"]}return(await b.get(e.URL+"/query?"+new URLSearchParams(i))).data["cursor-id"]}async exportResults(t){let i=await D.fetchCursorId(this.sessionId,t);s.Log(I,`cursorId: ${i}`);let n={"session-id":this.sessionId,"cursor-id":i,"req-id":b.uuid(),"num-of-rows":-1,export:!0},a=new w(e.WS_URL+"/fetch_ws?"+new URLSearchParams(n));_.setOptions({buttons:!0,cancel:()=>{D.cancel(this.sessionId,i),s.Log(I,`Cancelled ${i}`)}}),f.publish(e.INIT_PROGRESS,{title:"Running query",message:"Please wait"});let o="",l=0,d=r.ERR_NONE,c=document.getElementById("copy-filename-template").innerHTML;for(;;){let s;try{s=await a.get()}catch(t){f.publish(e.STREAM_ERROR,{error:t}),d=t;break}if(1==s.length&&"eos"==s[0])break;if("header"!=s[0])"current-row"==s[0]&&(l+=s[1],f.publish(e.UPDATE_PROGRESS,{message:`Processed ${s[1]} rows`}));else{o=s[2];let r=b.processTemplate(c,{text:`Exporting to ${o}`,"file-name":o});f.publish(e.START_PROGRESS,{title:r}),f.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]})}}return l>0?f.publish(e.UPDATE_PROGRESS,{message:"Export complete"}):(f.publish(e.START_PROGRESS,{title:"No data"}),f.publish(e.UPDATE_PROGRESS,{message:"Processed 0 rows"})),f.publish(e.STOP_PROGRESS,{}),d==r.ERR_NONE?{status:"ok","rows-affected":l}:{status:"error",msg:d}}static createFKMap(e){s.Log(I,JSON.stringify(e));let t,r,i,n,a={};if(0==e.length)return a;let o=0;return e[0].forEach((e=>{switch(e){case"CONSTRAINT_NAME":n=o+1;break;case"COLUMN_NAME":t=o+1;break;case"REFERENCED_TABLE_NAME":r=o+1;break;case"REFERENCED_COLUMN_NAME":i=o+1}o++})),e.forEach((e=>{"NULL"!=e[r]&&(a[e[t]]={"ref-table":e[r],"ref-column":e[i]}),"PRIMARY"==e[n]&&(a["primary-key"]=e[t])})),a}static getLimit(t,s){return`${(t+s)*e.BATCH_SIZE_WS}, ${e.BATCH_SIZE_WS}`}static getOrder(e,t){return t?` order by \`${e}\` ${t}`:""}}const L="grid-resizer-h";class T{constructor(t,r,i,n,a){this.$grid=t,this.$grid.style.gridTemplateColumns=`${a.d1}fr 1px ${a.d2}fr`,this.d1=r.getBoundingClientRect().width,this.d2=n.getBoundingClientRect().width,s.Log(L,`${this.d1} ${this.d2}`),i.addEventListener("mousedown",(e=>{this.isDragging=!0,this.startx=e.clientX,s.Log(L,`mousedown: ${e.clientX}`),e.preventDefault()})),document.addEventListener("mousemove",(e=>{if(!this.isDragging)return;s.Log(L,`mousemove: ${e.clientX}`);let t=e.clientX-this.startx;this.d1+=t,this.d2+=-1*t,s.Log(L,`${t} ${this.d1} ${this.d2}`),this.$grid.style.gridTemplateColumns=`${this.d1}px 1px ${this.d2}px`,this.startx=e.clientX,e.preventDefault()})),document.addEventListener("mouseup",(t=>{this.isDragging=!1,s.Log(L,`mouseup: ${t.clientX}`),t.preventDefault(),f.publish(e.GRID_H_RESIZED,{d1:this.d1,d2:this.d2})}))}set(e){this.d1=e.d1,this.d2=e.d2,this.$grid.style.gridTemplateColumns=`${this.d1}px 1px ${this.d2}px`}}class v{constructor(e){this.fkMap=e,this.fkCellTemplate=document.getElementById("fk-cell-template").innerHTML,this.cellTemplate=document.getElementById("cell-template").innerHTML}render(e){s.Log("cell-renderer",`${e.colDef.field}`);let t=e.colDef.colId,r=e.colDef.field,i=e.data[`${r}-${t}`],n="",a="";this.fkMap[r]&&"NULL"!=i&&(n=this.fkMap[r]["ref-table"],a=this.fkMap[r]["ref-column"]);let o="NULL"==i?"null":"";return n?b.generateNode(this.fkCellTemplate,{value:i,table:n,column:a,"source-col":r,"source-id":t,"row-index":e.rowIndex}):b.generateNode(this.cellTemplate,{value:i,cls:o})}}class ${init(e){this.params=e,this.$header=document.createElement("div"),this.$header.innerHTML=`\n           <div class="customHeaderLabel">${this.params.displayName}</div>\n           <div class="customSortDownLabel inactive">\n               <i class="fa fa-long-arrow-alt-down"></i>\n           </div>\n           <div class="customSortUpLabel inactive">\n               <i class="fa fa-long-arrow-alt-up"></i>\n           </div>\n           <div class="customSortRemoveLabel inactive">\n               <i class="fa fa-times"></i>\n           </div>\n       `,this.$sortDown=this.$header.querySelector(".customSortDownLabel"),this.$sortUp=this.$header.querySelector(".customSortUpLabel"),this.$sortRemove=this.$header.querySelector(".customSortRemoveLabel"),this.params.enableSorting?(this.onSortAscRequestedListener=this.onSortRequested.bind(this,"asc"),this.$sortDown.addEventListener("click",this.onSortAscRequestedListener),this.onSortDescRequestedListener=this.onSortRequested.bind(this,"desc"),this.$sortUp.addEventListener("click",this.onSortDescRequestedListener),this.onRemoveSortListener=this.onSortRequested.bind(this,""),this.$sortRemove.addEventListener("click",this.onRemoveSortListener),this.onSortChangedListener=this.onSortChanged.bind(this),this.params.column.addEventListener("sortChanged",this.onSortChangedListener),this.onSortChanged()):(this.$header.removeChild(this.$sortDown),this.$header.removeChild(this.$sortUp),this.$header.removeChild(this.$sortRemove))}onSortChanged(e){const t=e=>{e.forEach((e=>{e.className=e.className.split(" ")[0]}))},s=e=>{e.className=e.className+" sort-active"};"asc"==e?(t([this.$sortUp,this.$sortRemove]),s(this.$sortDown)):"desc"==e?(t([this.$sortDown,this.$sortRemove]),s(this.$sortUp)):(t([this.$sortUp,this.$sortDown]),s(this.$sortRemove))}getGui(){return this.$header}onSortRequested(t,s){f.publish(e.SORT_REQUESTED,{column:this.params.column.colDef.field,order:t}),this.onSortChanged(t)}destroy(){this.$sortDown.removeEventListener("click",this.onSortRequestedListener),this.$sortUp.removeEventListener("click",this.onSortRequestedListener),this.$sortRemove.removeEventListener("click",this.onSortRequestedListener),this.params.column.removeEventListener("sortChanged",this.onSortChangedListener)}}const C="cell-editor";class N{init(e){let t=e.colDef.colId,r=e.colDef.field;this.value=e.data[`${r}-${t}`],this.input=document.createElement("input"),this.input.classList.add("input"),this.input.id="input",this.input.value=this.value,this.input.addEventListener("input",(e=>{this.value=e.target.value,s.Log(C,"listener:"+this.value)}))}getGui(){return this.input}getValue(){return s.Log(C,"getvalue:"+this.value),this.input.value}isCancelBeforeStart(){return!1}isCancelAfterEnd(){return!1}afterGuiAttached(){this.input.focus()}}const O="table-utils";class q{constructor(t){this.$root=t,this.$loaderTemplate=document.getElementById("table-loader-template").innerHTML,this.init(),document.addEventListener("click",(t=>{"cancel-query"==t.target.parentElement.id&&(s.Log(O,"Cancel clicked"),f.publish(e.QUERY_CANCELLED,{}))}))}async init(){await class{static init(){return new Promise(((e,t)=>{let s=document.createElement("script");s.src="/build-0.6/js/ag-grid-community.min.noStyle.js",document.head.appendChild(s);let r=document.createElement("link");r.href="/build-0.6/css/ag-grid.css",r.type="text/css",r.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(r),r=document.createElement("link"),r.href="/build-0.6/css/ag-theme-alpine.css",r.type="text/css",r.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(r),s.onload=()=>{e(agGrid.Grid)}}))}}.init()}async showContents(t,s,i={},n=!1,a=!1){this.fkMap=s;let o=this.createGrid();this.showLoader();let l=0,d=r.ERR_NONE,c=Date.now();for(;;){let r;try{r=await t.get()}catch(t){f.publish(e.STREAM_ERROR,{error:t}),d=t;break}if(1==r.length&&"eos"==r[0])break;0==l&&this.setupGrid(o,r,s,i,n,a);let c={},u=0;for(let e=0;e<r.length;e+=2)c[`${r[e]}-${u}`]=r[e+1],u++;this.api.applyTransactionAsync({add:[c]}),l++}if(this.hideLoader(),0==l){let e={};new agGrid.Grid(o,e),this.api=e.api,this.api.showNoRowsOverlay()}if(this.numOfRows=l,d==r.ERR_NONE){let e=Date.now();return{status:"ok","rows-affected":this.numOfRows,"time-taken":e-c}}return{status:"error",msg:d}}createGrid(){let e=this.$root.querySelector("#grid");null!=e&&e.remove();let t=b.generateNode('<div id="grid" class="ag-theme-alpine"></div>',{});return this.$root.append(t),this.$root.querySelector("#grid")}setupGrid(t,r,i,n,a,o){let l={columnDefs:this.setupColumns(r,i,n,a),undoRedoCellEditing:!0,rowSelection:"single",onSelectionChanged:()=>{this.onSelectionChanged(i)},onCellClicked:()=>{s.Log(O,"onCellClicked"),f.publish(e.GRID_HAS_FOCUS,{})}};o&&(l.components={agColumnHeader:$}),new agGrid.Grid(t,l),this.gridOptions=l,this.api=l.api,this.api.hideOverlay()}onSelectionChanged(t){if(b.isEmpty(t))return;const r=this.gridOptions.api.getSelectedRows();s.Log(O,"fkMap:"+JSON.stringify(t)),s.Log(O,"onSelectionChanged:"+JSON.stringify(r));for(let s in r[0])if(s==t["primary-key"]+"-"+t["primary-key-id"]){f.publish(e.ROW_SELECTED,{key:t["primary-key"],value:r[0][s]});break}}setupColumns(e,t,r,i){let n=[],a=new v(t),o=0;for(let l=0;l<e.length;l+=2){let d=r[o]??!0;e[l]==t["primary-key"]&&(t["primary-key-id"]=o),n.push({field:e[l],colId:o++,hide:!d,resizable:!0,editable:i,sortable:!0,onCellValueChanged:e=>{this.handleCellValueChanged(t,e)},cellRenderer:e=>a.render(e),cellEditor:N,valueGetter:e=>{s.Log(O,"valueGetter");let t=e.colDef.colId,r=e.colDef.field;return e.data[`${r}-${t}`]},valueSetter:e=>{s.Log(O,"valueSetter");let t=e.colDef.colId,r=e.colDef.field;return e.data[`${r}-${t}`]=e.newValue,!0},headerValueGetter:e=>(s.Log(O,"headerValueGetter:"+JSON.stringify(e.colDef)),e.colDef.field)})}return n}async update(t){let s=Date.now(),i=[];for(let e=0;e<this.numOfRows;e++){let t=this.api.rowModel.rowsToDisplay[e].data;i.push(t)}this.api.applyTransactionAsync({remove:i}),this.showLoader();let n=r.ERR_NONE,a=0;for(;;){let s;try{s=await t.get()}catch(t){f.publish(e.STREAM_ERROR,{error:t}),n=t;break}if(1==s.length&&"eos"==s[0])break;let r={},i=0;for(let e=0;e<s.length;e+=2)r[`${s[e]}-${i}`]=s[e+1],i++;this.api.applyTransactionAsync({add:[r]}),a++}if(this.numOfRows=a,this.hideLoader(),n==r.ERR_NONE){let e=Date.now();return{status:"ok","rows-affected":this.numOfRows,"time-taken":e-s}}return{status:"error",msg:n}}undo(){this.undoStarted=!0,this.api.undoCellEditing()}selectColumns(e){for(let t in e)this.gridOptions.columnApi.setColumnVisible(t,e[t])}handleCellValueChanged(t,r){if(this.undoStarted)return void(this.undoStarted=!1);s.Log(O,"handleCellValueChanged");let i=t["primary-key"],n=t["primary-key-id"],a=r.data[`${i}-${n}`],o=r.colDef.colId,l=r.colDef.field,d=r.data[`${l}-${o}`];f.publish(e.CELL_EDITED,{key:{name:i,value:a},col:{name:l,value:d},cell:{rowIndex:r.node.rowIndex,colId:r.colDef.colId}})}showLoader(){let e=b.generateNode(this.$loaderTemplate,{});document.querySelector("body").append(e);let t=document.querySelector(".table-loader"),s=this.$root.getBoundingClientRect();t.style.width=s.width+"px",t.style.height=s.height+"px",t.style.left=s.left+"px",t.style.top=s.top+"px";let r=t.querySelector("button");r.style.left=s.width/2+"px",r.style.top=s.height/4+"px"}hideLoader(){document.querySelector(".table-loader").remove()}clearInfo(){this.$timeTaken.innerText="",this.$rowsAffected.innerText=""}showInfo(e,t){let s=1==t?"row":"rows";this.$timeTaken.innerText=`${e} ms`,this.$rowsAffected.innerText=`${t} ${s} affected`}scrollTo(e){this.api.ensureIndexVisible(parseInt(e),"middle"),this.api.getRowNode(e).setSelected(!0)}}const A="grid-resizer-v";class k{constructor(t,r,i,n){this.$grid=t,this.d1=r.getBoundingClientRect().height,this.d2=n.getBoundingClientRect().height,s.Log(A,`${this.d1} ${this.d2}`),i.addEventListener("mousedown",(e=>{this.isDragging=!0,this.starty=e.clientY,s.Log(A,`mousedown: ${e.clientY}`),e.preventDefault()})),document.addEventListener("mousemove",(e=>{if(!this.isDragging)return;s.Log(A,`mousemove: ${e.clientY}`);let t=e.clientY-this.starty;this.d1+=t,this.d2+=-1*t,s.Log(A,`${t} ${this.d1} ${this.d2}`),this.$grid.style.gridTemplateRows=`${this.d1}px 2px ${this.d2}px`,this.starty=e.clientY,e.preventDefault()})),document.addEventListener("mouseup",(t=>{this.isDragging=!1,s.Log(A,`mouseup: ${t.clientY}`),t.preventDefault(),f.publish(e.GRID_V_RESIZED,{d1:this.d1,d2:this.d2})}))}set(e){this.d1=e.d1,this.d2=e.d2,this.$grid.style.gridTemplateRows=`${this.d1}px 2px ${this.d2}px`}}const U="ace",B=1e5;class M{constructor(e){this.elemId=e}init(){return new Promise(((t,r)=>{let i=document.createElement("script");i.src="/ace-builds/src-min/ace.js",document.head.appendChild(i),i.onload=()=>{this.editor=ace.edit(this.elemId),this.range=ace.require("ace/range").Range,this.editor.setTheme("ace/theme/github"),this.editor.session.setMode("ace/mode/mysql"),this.editor.setHighlightActiveLine(!1),this.editor.textInput.getElement().addEventListener("keyup",(()=>{this.onKeyup()})),this.editor.on("dblclick",(e=>{s.Log(U,"dblclick"),this.onKeyup()})),this.editor.on("mousedown",(e=>{s.Log(U,"mousedown"),setTimeout((()=>{this.onKeyup()}),5)})),this.editor.session.on("change",(t=>{f.publish(e.EDITOR_TEXT_CHANGED,{text:this.editor.getValue()})})),this.setKeyBindings(),t()}}))}resize(){this.editor.resize()}setValue(e){if(!this.selRange)return void this.editor.setValue(e);this.editor.session.replace(this.selRange,e+";"),this.editor.$search.setOptions({needle:";",backwards:!0,preventScroll:!0});let t=this.editor.selection.getCursor();this.editor.moveCursorTo(t.row,t.column-1),this.onKeyup()}clearSelection(){this.editor.clearSelection()}focus(){this.editor.focus()}getValue(){if(!this.selRange)return this.editor.getValue();let e=this.editor.session.getTextRange(this.selRange);return this.cleanup(e)}getAll(){return this.editor.getValue()}cleanup(e){let t=[" ",";"],s=0,r=e.length;for(;s<r&&t.indexOf(e[s])>=0;)++s;for(;r>s&&t.indexOf(e[r-1])>=0;)--r;return s>0||r<e.length?e.substring(s,r):e}onKeyup(e){this.marker&&this.editor.session.removeMarker(this.marker);let t=this.editor.selection.getCursor();s.Log(U,JSON.stringify(t)),this.updateSelRange(t),this.selRange&&(this.marker=this.editor.session.addMarker(this.selRange,"ace_active-line","text"))}updateSelRange(e){this.editor.$search.setOptions({needle:";",backwards:!0,preventScroll:!0,wrap:!0});let t=0,r=0,i=this.editor.session.getLength()-1,n=B,a=this.editor.$search.findAll(this.editor.session);if(s.Log(U,JSON.stringify(a)),0==a.length)return void(this.selRange=null);for(let s=0;s<a.length;s++){let i=a[s];i.start.row<=e.row&&(i.start.row<e.row&&(t=i.start.row,r=i.start.column),i.start.row==e.row&&i.start.column<e.column&&(t=i.start.row,r=i.start.column))}for(let t=0;t<a.length;t++){let s=a[t];if(s.start.row>e.row){i=s.end.row,n=s.end.column;break}if(s.start.row==e.row&&s.start.column>=e.column){i=s.end.row,n=s.end.column;break}}let o=this.editor.session.getTextRange(new this.range(t,r,t,B));o=this.cleanup(o),o?r>0&&r++:(t++,r=0),s.Log(U,`sr ${t} sc ${r} er ${i} ec ${n}`),this.selRange=new this.range(t,r,i,n)}setKeyBindings(){this.editor.commands.addCommand({name:e.CMD_RUN_QUERY,bindKey:{win:e.SHIFT_R,mac:e.SHIFT_R},exec:t=>{f.publish(e.CMD_RUN_QUERY,{})},readOnly:!0}),this.editor.commands.addCommand({name:e.CMD_NEXT_ROWS,bindKey:{win:e.SHIFT_N,mac:e.SHIFT_N},exec:t=>{f.publish(e.CMD_NEXT_ROWS,{})},readOnly:!0}),this.editor.commands.addCommand({name:e.CMD_PREV_ROWS,bindKey:{win:e.SHIFT_P,mac:e.SHIFT_P},exec:t=>{f.publish(e.CMD_PREV_ROWS,{})},readOnly:!0}),this.editor.commands.addCommand({name:e.CMD_EXPORT,bindKey:{win:e.SHIFT_E,mac:e.SHIFT_E},exec:t=>{f.publish(e.CMD_EXPORT,{})},readOnly:!0}),this.editor.commands.addCommand({name:e.CMD_FORMAT_QUERY,bindKey:{win:e.SHIFT_T,mac:e.SHIFT_T},exec:t=>{s.Log(U,"format"),f.publish(e.CMD_FORMAT_QUERY,{})},readOnly:!0}),this.editor.commands.addCommand({name:e.CMD_RUN_ALL,bindKey:{win:e.SHIFT_A,mac:e.SHIFT_A},exec:t=>{s.Log(U,"runall"),f.publish(e.CMD_RUN_ALL,{})},readOnly:!0})}}const x="query-runner",P="query-runner-query",H="query-runner-grid-v-dimensions";class G{constructor(t){this.sessionId=t,s.Log(x,`sessionId: ${t}`),this.init(),f.subscribe(e.STREAM_ERROR,(t=>{s.Log(x,`${e.STREAM_ERROR}: ${JSON.stringify(t)}`),r.handle(t)})),f.subscribe(e.QUERY_CANCELLED,(()=>{D.cancel(this.sessionId,this.cursorId)})),f.subscribe(e.GRID_H_RESIZED,(()=>{this.editor.resize()})),f.subscribe(e.GRID_V_RESIZED,(e=>{this.editor.resize(),b.saveToSession(H,JSON.stringify(e))})),f.subscribe(e.CELL_EDITED,(async e=>{this.tableUtils.undo()})),f.subscribe(e.EDITOR_TEXT_CHANGED,(async e=>{""!=e.text.trim()?b.saveToSession(P,e.text):b.removeFromSession(P)})),[e.CMD_RUN_QUERY,e.CMD_RUN_ALL,e.CMD_NEXT_ROWS,e.CMD_PREV_ROWS,e.CMD_EXPORT,e.CMD_FORMAT_QUERY].forEach((e=>{(e=>{f.subscribe(e,(()=>{this.handleCmd(e)}))})(e)}))}setSessionInfo(e,t){this.sessionId=e,this.db=t,s.Log(x,`sessionId: ${e} db: ${t}`)}async init(){this.$root=document.getElementById("app-right-panel"),this.$footer=document.getElementById("footer-right-panel"),this.$timeTaken=document.getElementById("time-taken"),this.$rowsAffected=document.getElementById("rows-affected"),this.editor=new M("query-editor"),await this.editor.init();let t=document.getElementById("query-container"),s=document.getElementById("query-editor"),r=document.getElementById("query-results"),i=document.getElementById("query-container-resizer"),n=new k(t,s,i,r),a=b.getFromSession(H);null!=a&&(n.set(JSON.parse(a)),this.editor.resize()),this.$queryResults=document.getElementById("query-results"),this.$table=this.$queryResults.querySelector("table"),this.tableUtils=new q(this.$queryResults),this.$formatQuery=document.getElementById("format-query"),this.$formatQuery.addEventListener("click",(async t=>{this.handleCmd(e.CMD_FORMAT_QUERY)})),this.$runQuery=document.getElementById("run-query"),this.$runQuery.addEventListener("click",(async t=>{this.handleCmd(e.CMD_RUN_QUERY)})),this.$runAll=document.getElementById("run-all"),this.$runAll.addEventListener("click",(async t=>{this.handleCmd(e.CMD_RUN_ALL)})),this.$exportResults=document.getElementById("export-results"),this.$exportResults.addEventListener("click",(async t=>{this.handleCmd(e.CMD_EXPORT)})),this.$next=document.getElementById("next"),this.$next.addEventListener("click",(async t=>{this.handleCmd(e.CMD_NEXT_ROWS)})),this.restoreState()}restoreState(){let e=b.getFromSession(P);null!=e&&this.editor.setValue(e)}async handleCmd(t){let s;switch(t){case e.CMD_RUN_QUERY:this.cursorId=null,s=this.editor.getValue(),this.runQuery(s);break;case e.CMD_RUN_ALL:this.runAll();break;case e.CMD_NEXT_ROWS:s=this.editor.getValue(),this.runQuery(s,!1);break;case e.CMD_EXPORT:this.handleExport();break;case e.CMD_FORMAT_QUERY:this.formatQuery()}}async handleExport(){let t=this.editor.getValue(),s=new D;await s.exportResults.apply(this,[t])==r.ERR_NONE&&f.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]})}async runQuery(t,s=!0){if(!this.db)return alert("No database selected"),{status:"error",msg:"No database selected"};if(this.tableUtils.clearInfo.apply(this),t=t.trim(),!/^select|show|explain/i.test(t)){let r=Date.now();this.tableUtils.showLoader();let i=new D,n=await i.execute.apply(this,[t]);if("error"==n.status)return this.tableUtils.hideLoader(),n;s&&f.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]});let a=Date.now();return this.tableUtils.showInfo.apply(this,[a-r,n.data[0][1]]),this.tableUtils.hideLoader(),{status:"ok","rows-affected":n.data[0][1]}}this.cursorId||(this.cursorId=await D.fetchCursorId(this.sessionId,t));let r={"session-id":this.sessionId,"cursor-id":this.cursorId,"req-id":b.uuid(),"num-of-rows":e.BATCH_SIZE_WS},i=new w(e.WS_URL+"/fetch_ws?"+new URLSearchParams(r)),n=await this.tableUtils.showContents(i,{},{},!0);return"ok"==n.status&&(this.tableUtils.showInfo.apply(this,[n["time-taken"],n["rows-affected"]]),f.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]})),n}async runAll(){let e=this.split(this.editor.getAll());for(let t=0;t<e.length;t++){let r=e[t];s.Log(x,`running: ${r}`),this.cursorId=null;let i=await this.runQuery(r);if("error"==i.status){s.Log(x,`runall breaking: ${i.msg}`);break}s.Log(x,`${i["rows-affected"]}`)}}split(e){let t=[],s=sqlFormatter.format(e,{language:"mysql"}).tokens,r="";return s.forEach((e=>{if("operator"==e.type&&";"==e.value)return t.push(r),void(r="");r+=e.whitespaceBefore+e.value})),r.trim(),""!=r&&t.push(r),t}async formatQuery(){let e=this.editor.getValue();e=sqlFormatter.format(e,{language:"mysql"}),s.Log(x,JSON.stringify(e.tokens)),this.editor.setValue(e.query),this.editor.clearSelection(),this.editor.focus()}}const V="query-finder",Q="query-finder-terms",F="query-finder-tags";class Y{constructor(){this.$queries=document.getElementById("queries"),this.queryTemplate=document.getElementById("query-template").innerHTML,this.tootipTemplate=document.getElementById("tooltip-template").innerHTML}async init(){this.queryDb=new c(new s,{version:e.QUERY_DB_VERSION}),await this.queryDb.open();let t=await this.queryDb.filter({start:10,end:0},[],[]);this.showQueries(t),s.Log(V,JSON.stringify(t)),f.subscribe(e.QUERY_SAVED,(async()=>{this.reload()})),f.subscribe(e.NEW_QUERIES,(async()=>{this.reload()})),this.restoreState(),this.initTermInput(),this.initTagInput(),this.initTagEditor(),this.initTooltip()}restoreState(){let e=[{key:Q,input:"term-input"},{key:F,input:"tags-input"}];for(let t=0;t<e.length;t++){let r=e[t],i=b.getFromSession(r.key);if(null==i)continue;i=JSON.parse(i);let n="";i.forEach((e=>{n+=e.value+" "})),s.Log(V,"restorestate: "+n),document.getElementById(r.input).value=n,r.key==Q&&b.removeFromSession(F);break}}async reload(){let e=await this.queryDb.filter({start:10,end:0},[],[]);this.showQueries(e),s.Log(V,JSON.stringify(e))}initTooltip(){this.$queries.addEventListener("click",(async e=>{if(!e.target.classList.contains("query-text"))return;s.Log(V,e.target.classList);let t=parseInt(e.target.dataset.id),r=(await this.queryDb.findByIds([t]))[0],i=tippy(document.querySelector(`.query[data-id="${t}"]`),{onHidden(e){s.Log(V,"destroying"),e.destroy()}}),n=sqlFormatter.format(r.query,{language:"mysql"});i.setProps({content:b.processTemplate(this.tootipTemplate,{id:t,query:n.query}),placement:"right",delay:0,allowHTML:!0,interactive:!0}),i.show()})),this.$queries.addEventListener("click",(async e=>{if(!e.target.classList.contains("copy-query"))return;let t=parseInt(e.target.dataset.id);s.Log(V,`Copying ${t}`);let r=(await this.queryDb.findByIds([t]))[0],i=sqlFormatter.format(r.query,{language:"mysql"});await navigator.clipboard.writeText(i.query),e.target.nextElementSibling.innerHTML="&nbsp;&nbsp;&nbsp;Copied."}))}initTermInput(){let e=document.querySelector("#term-input"),t=new Tagify(e,{placeholder:"Search queries"});if(t.on("input",(async e=>{var r=e.detail.value;t.whitelist=null,t.loading(!0).dropdown.hide();let i=await this.queryDb.listTerms(r);s.Log(V,i),t.whitelist=i,t.loading(!1).dropdown.show(r)})),e.addEventListener("change",(async e=>{let t=[];if(""==e.target.value){let e=await this.queryDb.filter({start:10,end:0},[],[]);return this.showQueries(e),void b.removeFromSession(Q)}s.Log(V,e.target.value);let r=JSON.parse(e.target.value);for(let e=0;e<r.length;e++)t.push(r[e].value);s.Log(V,t);let i=await this.queryDb.filter({start:1e4,end:0},[],t);this.showQueries(i),b.saveToSession(Q,e.target.value)})),""!=e.value){let t=new Event("change");e.dispatchEvent(t)}}initTagInput(){let e=document.querySelector("#tags-input"),t=new Tagify(e,{placeholder:"Search tags"});if(t.on("input",(async e=>{var r=e.detail.value;t.whitelist=null,t.loading(!0).dropdown.hide();let i=await this.queryDb.listTags(r);s.Log(V,i),t.whitelist=i,t.loading(!1).dropdown.show(r)})),e.addEventListener("change",(async e=>{let t=[];if(""==e.target.value){let e=await this.queryDb.filter({start:10,end:0},[],[]);return this.showQueries(e),void b.removeFromSession(F)}s.Log(V,e.target.value);let r=JSON.parse(e.target.value);for(let e=0;e<r.length;e++)t.push(r[e].value);s.Log(V,t);let i=await this.queryDb.filter({start:1e4,end:0},t,[]);this.showQueries(i),b.saveToSession(F,e.target.value)})),""!=e.value){let t=new Event("change");e.dispatchEvent(t)}}async showQueries(e){this.$queries.replaceChildren(),e.forEach((e=>{let t=b.generateNode(this.queryTemplate,{id:e.id,query:b.truncate(e.query,50),timestamp:e.created_at.toLocaleString(),time:e.time??"",rows:e.rows??""});e.tags.forEach((e=>{let s=b.generateNode(`<span class=tag>${e}</span>`,{});t.querySelector(".query-tags").append(s)})),this.$queries.append(t)}))}initTagEditor(){document.addEventListener("mouseover",(t=>{if(s.Log(V,"mouseover:"+t.classList),t.target.classList.contains("query-tags")){s.Log(V,"on query");let r=t.target,i=r;if(i.querySelector(".new-tag"))return;let n=parseInt(r.dataset.id),a=b.generateNode('<span class="tag new-tag" contenteditable>click to add new</span>',{});i.append(a),((t,r)=>{r.addEventListener("keyup",(async i=>{if("Tab"==i.key||"Enter"==i.key){let i=r.innerText.trim();if(""==i)return void r.blur();s.Log(V,`Setting tag ${i} on id ${t}`),r.classList.remove("new-tag"),r.blur();let n=(await this.queryDb.findByIds([t]))[0];n.tags.push(i),s.Log(V,n),await this.queryDb.updateTags(n),f.publish(e.QUERY_UPDATED,{id:t})}"Escape"==i.key&&(r.innerHTML="click to add new",r.blur())})),r.addEventListener("click",(e=>{r.innerHTML="<span>&nbsp</span>"}))})(n,i.querySelector(".new-tag")),(e=>{e.addEventListener("mouseleave",(()=>{s.Log(V,"outside query");let t=e.querySelector(".new-tag");t&&t.remove()}))})(r)}}))}}const j="file-uploader";class W{constructor(){this.mID="fu-"+b.uuid();let t=document.getElementById("file-upload-template").innerHTML,r=b.generateNode(t,{"fu-id":this.mID});document.querySelector("body").append(r),document.querySelector("[type=file]").addEventListener("change",(t=>{if(s.Log(j,"changed"),t.target.files.length>0){let s=new FileReader;s.readAsText(t.target.files[0]),s.addEventListener("load",(()=>{try{let t=JSON.parse(s.result);f.publish(e.FILE_UPLOADED,t)}catch(e){return void alert(e)}finally{document.querySelector(`#${this.mID}`).remove()}}))}}))}show(){s.Log(j,"Showing "+this.mID),document.querySelector("[type=file]").click()}}const J="query-history";class X{constructor(){f.subscribe(e.QUERY_DISPATCHED,(async t=>{s.Log(J,JSON.stringify(t)),this.queryDb||await this.init(),t.terms=b.getTerms(t.query);let r=await this.queryDb.save(t);s.Log(J,`Saved to ${r}`),f.publish(e.QUERY_SAVED,{id:r})})),f.subscribe(e.FILE_UPLOADED,(async e=>{await this.handleUpload(e)}));let t=document.getElementById("download-history");t&&(t.addEventListener("click",(async()=>{await this.handleDownload()})),document.getElementById("import-file").addEventListener("click",(async()=>{(new W).show()})))}async init(){this.queryDb=new c(new s,{version:e.QUERY_DB_VERSION}),await this.queryDb.open()}async handleDownload(){let e=await this.queryDb.filter({start:1e4,end:0},[],[]);for(let t=0;t<e.length;t++){let s=e[t],r=s.created_at.getFullYear(),i=s.created_at.getMonth(),n=s.created_at.getDate(),a=s.created_at.getHours(),o=s.created_at.getMinutes(),l=s.created_at.getSeconds();e[t].year=r,e[t].month=i,e[t].date=n,e[t].hours=a,e[t].minutes=o,e[t].seconds=l,delete e[t].created_at}(class{static download(e,t,s,r){var i=new Blob(void 0!==r?[r,e]:[e],{type:s||"application/octet-stream"});if(void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(i,t);else{var n=window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(i):window.webkitURL.createObjectURL(i),a=document.createElement("a");a.style.display="none",a.href=n,a.setAttribute("download",t),void 0===a.download&&a.setAttribute("target","_blank"),document.body.appendChild(a),a.click(),setTimeout((function(){document.body.removeChild(a),window.URL.revokeObjectURL(n)}),200)}}}).download(JSON.stringify(e),"data.json","application/json")}async handleUpload(t){_.setOptions({}),f.publish(e.INIT_PROGRESS,{}),f.publish(e.START_PROGRESS,{});for(let r=0;r<t.length;r++){let i=t[r];i.id&&delete i.id;let n=new Date;n.setFullYear(i.year),n.setMonth(i.month),n.setDate(i.date),n.setHours(i.hours),n.setMinutes(i.minutes),n.setSeconds(i.seconds),delete i.year,delete i.month,delete i.date,delete i.hours,delete i.minutes,delete i.seconds,i.created_at=n,i.terms=b.getTerms(i.query);let a=await this.queryDb.save(i);f.publish(e.UPDATE_PROGRESS,{message:`Imported ${r+1} of ${t.length}`}),s.Log(J,`Saved to ${a}`)}f.publish(e.STOP_PROGRESS,{})}}class K{static init(){document.querySelectorAll('[id$="-menu"]').forEach((e=>{e.addEventListener("click",(e=>{s.Log("main-menu",`${e.currentTarget.id} clicked `),K.handleMenu(e.currentTarget.id)}))}))}static handleMenu(e){switch(e){case"query-menu":window.location="/app/queries";break;case"content-menu":window.location="/app/tables";break;case"help-menu":window.open("/app/help","_blank");break;case"about-menu":window.open("/app/about","_blank")}}}const Z="db-renamer";class z{constructor(t){this.sessionId=t,this.$dialog=document.getElementById("db-renamer-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$title=this.$dialog.querySelector(".modal-card-title"),this.$name=this.$dialog.querySelector("#new-db-name"),this.$ok.addEventListener("click",(async()=>{this.closeDialog(),_.setOptions({}),f.publish(e.INIT_PROGRESS,{}),f.publish(e.START_PROGRESS,{});try{let t=await this.getCurrentDbAttribs();f.publish(e.UPDATE_PROGRESS,{message:`Renaming ${this.db} to ${this.$name.value}`}),s.Log(Z,`Renaming ${this.db} to ${this.$name.value}`),await this.createNewDb(this.$name.value,t),s.Log(Z,"Created new DB"),f.publish(e.UPDATE_PROGRESS,{message:`Created ${this.$name.value}`}),await this.renameTables(this.db,this.$name.value),s.Log(Z,"Renamed tables"),f.publish(e.UPDATE_PROGRESS,{message:"Renamed tables"}),f.publish(e.DB_RENAMED,{"new-db":this.$name.value})}catch(e){s.Log(Z,"Error: "+e)}finally{f.publish(e.STOP_PROGRESS,{})}})),this.$cancel.addEventListener("click",(()=>{D.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}async getCurrentDbAttribs(){let e=await D.fetchAll(this.sessionId,`SELECT default_character_set_name, default_collation_name FROM information_schema.SCHEMATA\n            WHERE schema_name = "${this.db}"`);return{charset:e[0][1],collation:e[0][3]}}async renameTables(t,r){let i=await D.fetchAll(this.sessionId,`show tables from \`${t}\``),n=new D;for(let a=0;a<i.length;a++){s.Log(Z,i[a][1]);let o=i[a][1],l=`rename table \`${t}\`.\`${o}\` to \`${r}\`.\`${o}\``,d=await n.execute.apply(this,[l]);if("ok"!=d.status)throw`${d.msg}`;f.publish(e.UPDATE_PROGRESS,{message:`Renamed ${o}`})}}async createNewDb(e,t){let s=`create database if not exists \`${e}\` \n            character set ${t.charset} collate ${t.collation}`,r=new D,i=await r.execute.apply(this,[s]);if("ok"!=i.status)throw`${i.msg}`}async deleteOldDb(e){let t=`drop database \`${e}\``,s=new D,r=await s.execute.apply(this,[t]);if("ok"!=r.status)throw`${r.msg}`}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionInfo(e,t){this.sessionId=e,this.db=t}init(e){this.db=e,this.title=`Rename ${this.db} to:`,this.$title.innerHTML=this.title,this.$name.value="",this.openDialog()}reset(){}}class ee{constructor(t){this.sessionId=t,this.$dialog=document.getElementById("db-deleter-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$body.innerHTML="This operation will delete the database. Are you sure?",this.$title=this.$dialog.querySelector(".modal-card-title"),this.time=this.$dialog.querySelector(".time"),this.$ok.addEventListener("click",(async()=>{this.$ok.setAttribute("disabled","disabled"),this.$cancel.setAttribute("disabled","disabled"),this.$title.innerHTML=`Deleting ${this.db}..`;let t=0,r=setInterval((()=>{t++,this.time.innerHTML=`${t} s`}),1e3),i=`drop database \`${this.db}\``;s.Log("db-deleter",i);let n=new D,a=await n.execute.apply(this,[i]);if(clearInterval(r),"ok"==a.status)return f.publish(e.QUERY_DISPATCHED,{query:i,tags:[e.USER]}),a.data[0][1],b.showAlert(`Deleted database ${this.db}`,2e3),this.closeDialog(),this.$ok.removeAttribute("disabled"),void f.publish(e.DB_DELETED,{});this.$title.innerHTML=this.title})),this.$cancel.addEventListener("click",(()=>{D.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}openDialog(){this.$dialog.classList.add("is-active"),this.time.innerHTML="",this.$ok.removeAttribute("disabled"),this.$cancel.removeAttribute("disabled")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionInfo(e,t){this.sessionId=e,this.db=t}init(e){this.db=e,this.title=`Delete ${this.db}?`,this.$title.innerHTML=this.title,this.openDialog()}}const te="db-menu";class se{constructor(e,t){s.Log(te,`sessionId: ${e}`),this.sessionId=e,this.db=t,this.init()}setSessionInfo(e,t){this.sessionId=e,this.db=t,this.renamer.setSessionInfo(this.sessionId,this.db),this.deleter.setSessionInfo(this.sessionId,this.db),s.Log(te,`sessionId: ${e} db: ${t}`)}init(){this.initDom(),this.initHandlers(),this.renamer=new z(this.sessionId),this.deleter=new ee(this.sessionId)}initDom(){this.$dbMenu=document.getElementById("db-operations")}initHandlers(){this.$dbMenu.addEventListener("click",(()=>{if(!this.db)return void alert("No database selected");this.$dbMenu.parentNode.parentNode.classList.toggle("is-active")})),document.querySelectorAll('[class~="db-dropdown-item"]').forEach((e=>{e.addEventListener("click",(e=>{this.$dbMenu.parentNode.parentNode.classList.toggle("is-active"),this.handleMenu(e.currentTarget.id)}))}))}handleMenu(e){switch(s.Log(te,`id: ${e}`),e){case"rename-db":this.renamer.init(this.db);break;case"delete-db":this.deleter.init(this.db)}}}const re="appbar";class ie{constructor(t,r,i){this.sessionId=r,this.db=i,document.title=this.db,this.dbMenu=new se(this.sessionId,this.db),this.$databases=document.getElementById("databases"),document.getElementById("conn-name").innerHTML=`${t}&nbsp;&nbsp;&nbsp;`,this.showDatabases(),this.$databases.addEventListener("change",(()=>{this.db=this.$databases.value,s.Log(re,"Db changed to "+this.db),this.dbMenu.setSessionInfo(this.sessionId,this.db),document.title=this.db,f.publish(e.DB_CHANGED,{db:this.db}),this.$databases.blur()})),f.subscribe(e.DB_RENAMED,(async e=>{s.Log(re,"Db renamed"),this.db=e["new-db"],await this.showDatabases(),this.$databases.dispatchEvent(new Event("change")),this.$databases.blur()})),f.subscribe(e.DB_DELETED,(async e=>{s.Log(re,"Db deleted"),this.db="",await this.showDatabases(),this.$databases.dispatchEvent(new Event("change")),this.$databases.blur()}))}async showDatabases(){let e=await D.fetchAll(this.sessionId,"show databases");e=b.extractColumns(e),b.setOptions(this.$databases,e,this.db)}setSessionInfo(e){this.sessionId=e}}class ne{constructor(){this.$version=document.getElementById("version"),s.Log("workers",`ver: ${this.$version.value}`)}async initDb(){this.queryDb=new c(new s,{version:e.QUERY_DB_VERSION}),await this.queryDb.open()}initConnectionWorker(){this.connectionWorker=new SharedWorker(`/build-0.6/dist/js/connection-worker.js?ver=${this.$version.value}`),this.connectionWorker.port.onmessage=t=>{switch(t.data.type){case e.DEBUG_LOG:s.Log("connection-worker",t.data.payload);break;case e.NEW_CONNECTIONS:f.publish(e.NEW_CONNECTIONS,{})}}}async initQueryWorker(){await this.initDb(),this.queryWorker=new SharedWorker(`/build-0.6/dist/js/query-worker.js?ver=${this.$version.value}`),this.queryWorker.port.onmessage=async t=>{switch(t.data.type){case e.DEBUG_LOG:s.Log("query-worker",t.data.payload);break;case e.NEW_QUERIES:f.publish(e.NEW_QUERIES,{});break;case e.EXECUTE_SAVE_REC:s.Log("query-worker",e.EXECUTE_SAVE_REC);let r=t.data.data;r.terms=b.getTerms(r.query);let i=await this.queryDb.save(r);this.queryWorker.port.postMessage({type:e.EXECUTE_SUCCESS,data:i})}}}}const ae="queries",oe="queries-grid-h-dimensions";new class{constructor(){document.addEventListener("DOMContentLoaded",(async()=>{this.adjustView(),this.init()})),b.saveToSession(e.CURRENT_PAGE,ae)}async initHandlers(){f.subscribe(e.DB_CHANGED,(async t=>{s.Log(ae,"Db changed"),this.creds.db=t.db,b.saveToSession(e.CREDS,JSON.stringify(this.creds)),this.sessionId=await D.login(this.creds),this.setSessionInfo()})),f.subscribe(e.GRID_H_RESIZED,(e=>{b.saveToSession(oe,JSON.stringify(e))})),this.workers=new ne,this.workers.initQueryWorker(),this.workers.initConnectionWorker(),f.subscribe(e.QUERY_SAVED,(async()=>{this.workers.queryWorker.port.postMessage({type:e.QUERY_SAVED})})),f.subscribe(e.QUERY_UPDATED,(async()=>{this.workers.queryWorker.port.postMessage({type:e.QUERY_UPDATED})}))}async init(){let t=document.getElementById("app-content"),r=document.getElementById("app-left-panel-container"),i=document.getElementById("app-right-panel"),n=document.getElementById("app-content-resizer"),a=new T(t,r,n,i,{d1:3,d2:8}),o=b.getFromSession(oe);null!=o&&a.set(JSON.parse(o)),K.init();let l=b.getFromSession(e.CREDS);l?(this.creds=JSON.parse(l),this.sessionId=await D.login(this.creds),s.Log(ae,this.sessionId),this.queryRunner=new G(this.sessionId),this.history=new X,await this.history.init(),this.finder=new Y,await this.finder.init(),this.initHandlers(),this.appbar=new ie(this.creds.name,this.sessionId,this.creds.db),this.creds.db&&this.setSessionInfo()):window.location="/connections"}setSessionInfo(){this.queryRunner.setSessionInfo(this.sessionId,this.creds.db),this.appbar.setSessionInfo(this.sessionId)}adjustView(){let e=document.querySelector("body").getBoundingClientRect(),t=document.querySelector("#appbar").getBoundingClientRect();document.querySelector("#app-left-panel").style.height=e.height-t.height+"px",document.getElementById("app-right-panel").style.height=e.height-t.height+"px"}}}();
