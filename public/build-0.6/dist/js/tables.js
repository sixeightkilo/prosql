!function(){"use strict";class e{static get SHIFT_A(){return"Alt+Shift+A"}static get SHIFT_R(){return"Alt+Shift+R"}static get SHIFT_T(){return"Alt+Shift+T"}static get SHIFT_O(){return"Alt+Shift+O"}static get SHIFT_E(){return"Alt+Shift+E"}static get SHIFT_N(){return"Alt+Shift+N"}static get SHIFT_P(){return"Alt+Shift+P"}static get SHIFT_L(){return"Alt+Shift+L"}static get SHIFT_S(){return"Alt+Shift+S"}static get SHIFT_BACK(){return"Alt+Shift+,"}static get CMD_RUN_QUERY(){return"cmd.run-query"}static get CMD_RUN_ALL(){return"cmd.run-all"}static get CMD_FORMAT_QUERY(){return"cmd.format-query"}static get CMD_EXPORT(){return"cmd.export"}static get CMD_CLEAR_FILTER(){return"cmd.clear-filter"}static get CMD_NEXT_ROWS(){return"cmd.next-rows"}static get CMD_PREV_ROWS(){return"cmd.prev-rows"}static get CMD_FORMAT_QUERY(){return"cmd.format-query"}static get CMD_EXPORT_TABLE(){return"cmd.export-table"}static get CMD_SEARCH_TABLES(){return"cmd.search-tables"}static get CMD_BACK(){return"cmd.back"}static get DB_RENAMED(){return"db-menu.db-renamed"}static get DB_DELETED(){return"db-menu.db-deleted"}static get TABLE_RENAMED(){return"ops-menu.table-renamed"}static get TABLE_TRUNCATED(){return"ops-menu.table-truncated"}static get ROW_SELECTED(){return"table-utils.row-selected"}static get ROW_DELETED(){return"row-deleter.row-deleted"}static get COLUMNS_SELECTED(){return"cmd.columns-selected"}static get STREAM_ERROR(){return"stream.stream-error"}static get SORT_REQUESTED(){return"table-utils.sort-requested"}static get QUERY_CANCELLED(){return"table-utils.query-cancelled"}static get TABLE_SELECTED(){return"tables.table-selected"}static get CELL_EDITED(){return"tables.cell-edited"}static get TABLE_CHANGED(){return"table-contents.table-changed"}static get DB_CHANGED(){return"appbar.db-changed"}static get GRID_H_RESIZED(){return"gridh.resized"}static get QUERY_DISPATCHED(){return"query-dispatched"}static get FILE_UPLOADED(){return"file-uploaded"}static get QUERY_SAVED(){return"query-saved"}static get CONNECTION_SAVED(){return"connection-saved"}static get CONNECTION_DELETED(){return"connection-deleted"}static get QUERY_UPDATED(){return"query-updated"}static get SESSION_ID(){return"session-id"}static get URL(){return"http://localhost:23890"}static get WS_URL(){return"ws://localhost:23890"}static get DB_NAME(){return"prosql"}static get DB_VERSION(){return 1}static get CONNECTIONS(){return"connections"}static get COLUMN_SELECTIONS(){return"column-selections"}static get BATCH_SIZE(){return 1e3}static get BATCH_SIZE_WS(){return 1e3}static get CREDS(){return"creds"}static get SYSTEM(){return"system"}static get USER(){return"user"}static get DB_ID_INDEX(){return"db-id-index"}static get CONNECTIONS_META_KEY(){return 1}static get QUERIES_META_KEY(){return 2}static get CONNECTIONS_META_DB_VERSION(){return 1}static get QUERIES_META_DB_VERSION(){return 1}static get QUERY_DB_VERSION(){return 39}static get CONN_DB_VERSION(){return 4}static get INIT_PROGRESS(){return"init-progress"}static get START_PROGRESS(){return"start-progress"}static get STOP_PROGRESS(){return"stop-progress"}static get UPDATE_PROGRESS(){return"update-progress"}static get DEBUG_LOG(){return"worker.debug-log"}static get SIGNIN_REQUIRED(){return"worker.signin-required"}static get NEW_CONNECTIONS(){return"worker.new-connection"}static get NEW_QUERIES(){return"worker.new-queries"}static get EXECUTE_SAVE_REC(){return"worker.execute-save-rec"}static get EXECUTE_SUCCESS(){return"app.execute-success"}static get EXECUTE_ERROR(){return"app.execute-error"}static get STATUS_ACTIVE(){return"active"}static get STATUS_DELETED(){return"deleted"}static get EPOCH_TIMESTAMP(){return"2021-01-01T00:00:00Z"}static get LAST_SYNC_TS(){return"last-sync-ts"}}const t=["grid-resizer"];class s{constructor(e=null){this.port=e}log(i,r){t.includes(i)||(this.port?this.port.postMessage({type:e.DEBUG_LOG,payload:`${i}: ${r}`}):s.print(i,r))}static Log(e,i){t.includes(e)||s.print(e,i)}static print(e,t){let[s,i,r]=(new Date).toLocaleDateString("en-US").split("/"),[a,n,o]=(new Date).toLocaleTimeString("en-US").split(/:| /),l=`${i}-${s}-${r} ${a}:${n}:${o}:::${e}: ${t}`;console.log(l)}}class i{static get ERR_NONE(){return"none"}static get ERR_NO_AGENT(){return"no-agent"}static get ERR_INVALID_USER_INPUT(){return"invalid-user-input"}static get ERR_INVALID_SESSION_ID(){return"invalid-session-id"}static get ERR_SIGNIN_REQUIRED(){return"signin-required"}static get ERR_INVALID_CURSOR_ID(){return"invalid-cursor-id"}static get ERR_DB_ERROR(){return"db-error"}static get ERR_UNRECOVERABLE(){return"unrecoverable-error"}static handle(e){e.error!=i.ERR_NO_AGENT?e.error!=i.ERR_INVALID_SESSION_ID?alert(e.error):window.location="/connections":window.location="/install"}}const r="base-db";class a{constructor(e,t){this.logger=e,this.version=t.version,this.dbName=t.dbName}async open(){return new Promise(((e,t)=>{let s=indexedDB.open(this.dbName,this.version);s.onsuccess=t=>{this.logger.log(r,"open.onsuccess"),this.db=s.result,e(0)},s.onerror=e=>{this.logger.log(r,e.target.error),t(e.target.errorCode)},s.onupgradeneeded=e=>{this.onUpgrade(e)}}))}async save(e,t){return new Promise(((s,i)=>{let a=this.db.transaction([e],"readwrite").objectStore(e).add(t);a.onsuccess=e=>{s(e.target.result)},a.onerror=e=>{this.logger.log(r,e.target.error),s(-1)}}))}async put(e,t){return new Promise(((s,i)=>{let a=this.db.transaction([e],"readwrite").objectStore(e);t.updated_at=new Date;let n=a.put(t);n.onsuccess=e=>{s(0)},n.onerror=e=>{this.logger.log(r,e.target.error),s(-1)}}))}async destroy(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.store,"readwrite").objectStore(this.store).delete(e);i.onsuccess=e=>{t(0)},i.onerror=e=>{t(e.target.error)}}))}async del(t){return new Promise(((s,i)=>{let r=this.db.transaction(this.store,"readwrite").objectStore(this.store),a=r.get(t);a.onsuccess=t=>{let i=t.target.result;i.status=e.STATUS_DELETED;let a=r.put(i);a.onerror=e=>{s(e.target.error)},a.onsuccess=e=>{s(0)}},a.onerror=e=>{s(e.target.error)}}))}async get(e,t=[]){return new Promise(((s,i)=>{let a=this.db.transaction(this.store).objectStore(this.store).get(e);a.onsuccess=e=>{let i=[];if(t.length>0)for(let e in a.result)t.includes(e)&&(i[e]=a.result[e]);else i=a.result;this.logger.log(r,JSON.stringify(i)),s(i)},a.onerror=e=>{s(null)}}))}async getAll(e=[]){return new Promise(((t,s)=>{let i=this.db.transaction(this.store).objectStore(this.store),r=[];i.openCursor().onsuccess=s=>{var i=s.target.result;if(i){if(e.length>0){let t={};for(let s in i.value)e.includes(s)&&(t[s]=i.value[s]);r.push(t)}else r.push(i.value);i.continue()}else t(r)}}))}async reset(t){return new Promise(((s,i)=>{let r=this.db.transaction(this.store,"readwrite").objectStore(this.store),a=r.get(t.id);a.onsuccess=t=>{let i=t.target.result;i.db_id=null,i.synced_at=new Date(e.EPOCH_TIMESTAMP);let a=r.put(i);a.onerror=e=>{s(e.target.error)},a.onsuccess=e=>{s(0)}},a.onerror=e=>{s(e.target.error)}}))}async sync(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.store,"readwrite").objectStore(this.store),r=i.get(e.id);r.onsuccess=s=>{let r=s.target.result;r.db_id=e.db_id,r.synced_at=new Date;let a=i.put(r);a.onerror=e=>{t(e.target.error)},a.onsuccess=e=>{t(0)}},r.onerror=e=>{t(e.target.error)}}))}async findByDbId(t){return new Promise(((s,i)=>{this.logger.log(r,"findByDbId");let a=this.db.transaction(this.store).objectStore(this.store).index(e.DB_ID_INDEX).get(IDBKeyRange.only([t]));a.onsuccess=e=>{s(a.result)},a.onerror=e=>{this.logger.log(r,"error"),s(e.target.error)}}))}static toDb(e={}){let t={};for(let s in e)t[s.replaceAll(/-/g,"_")]=e[s];return t}static toDbArray(e=[]){let t=[];return e.forEach((e=>{t.push(e.replaceAll(/-/g,"_"))})),t}static fromDbArray(e=[]){let t=[];return e.forEach((e=>{let s={};for(let t in e)s[t.replaceAll(/_/g,"-")]=e[t];t.push(s)})),t}static fromDb(e={}){let t={};for(let s in e)t[s.replaceAll(/_/g,"-")]=e[s];return t}}const n="query-db",o="created-at-index",l="term-index",c="tag-index";class h extends a{constructor(e,t){t.dbName="queries",super(e,t),this.logger=e,this.store="queries",this.searchIndex="search-index",this.tagIndex="tag-index"}onUpgrade(t){if(this.logger.log(n,`onUpgrade: o: ${t.oldVersion} n: ${t.newVersion}`),t.oldVersion<2){let e=t.target.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0});e.createIndex(o,"created_at",{unique:!1}),e=t.target.result.createObjectStore(this.searchIndex,{keyPath:"id",autoIncrement:!0}),e.createIndex(l,"term",{unique:!0}),e=t.target.result.createObjectStore(this.tagIndex,{keyPath:"id",autoIncrement:!0}),e.createIndex(c,"tag",{unique:!0})}if(t.oldVersion<37){t.currentTarget.transaction.objectStore(this.store).createIndex(e.DB_ID_INDEX,["db_id"])}}async save(e){return new Promise((async(t,s)=>{e.query=e.query.replace(/[ ]{2,}/g," "),this.logger.log(n,JSON.stringify(e.terms));let i=-1;try{if(e.created_at||(e.created_at=new Date),i=await super.save(this.store,e),-1==i)return void t(-1);await this.updateSearchIndex(i,e.terms),await this.updateTagIndex(i,e.tags),t(i)}catch(e){this.logger.log(n,`error: ${JSON.stringify(e.message)}`),s(e.message)}}))}async updateSearchIndex(e,t){for(let s=0;s<t.length;s++){let i=t[s];if(i=i.trim(),!(i.length<=1)){i=this.cleanup(i);try{let t=await this.findByTerm(i);if(null==t){await super.save(this.searchIndex,{term:i,queries:[e]});continue}t.queries.push(e),this.logger.log(n,JSON.stringify(t)),super.put(this.searchIndex,{id:t.id,term:i,queries:t.queries})}catch(e){this.logger.log(n,"error: e.message")}}}}async findByTerm(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.searchIndex).objectStore(this.searchIndex).index(l),r=IDBKeyRange.only(e);i.openCursor(r).onsuccess=e=>{let s=e.target.result;if(s)return this.logger.log(n,JSON.stringify(s.value)),void t(s.value);t(null)}}))}async updateTagIndex(e,t){for(let s=0;s<t.length;s++){let i=t[s];if(i=i.trim(),!(i.length<=1)){i=this.cleanup(i);try{let t=await this.findByTag(i);if(null==t){await super.save(this.tagIndex,{tag:i,queries:[e]});continue}t.queries.push(e),this.logger.log(n,JSON.stringify(t)),super.put(this.tagIndex,{id:t.id,tag:i,queries:t.queries})}catch(e){this.logger.log(n,"error: e.message")}}}}async findByTag(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.tagIndex).objectStore(this.tagIndex).index(c),r=IDBKeyRange.only(e);i.openCursor(r).onsuccess=e=>{let s=e.target.result;if(s)return this.logger.log(n,JSON.stringify(s.value)),void t(s.value);t(null)}}))}async findByQuery(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.dbName).objectStore(this.store).index("query-index"),r=IDBKeyRange.only(e);i.openCursor(r).onsuccess=e=>{let s=e.target.result;if(s)return this.logger.log(n,JSON.stringify(s.value)),void t(s.value);t([])}}))}cleanup(e){let t=["`","`"," ",'"',"'",",",";","+","-","=","!=","<",">",">=","<="],s=0,i=(e=e.replace(/^\S+\./,"")).length;for(;s<i&&t.indexOf(e[s])>=0;)++s;for(;i>s&&t.indexOf(e[i-1])>=0;)--i;return s>0||i<e.length?e.substring(s,i):e}async filter(e,t,s){let i,r;this.logger.log(n,`filter: days ${JSON.stringify(e)} tags ${t} terms ${s}`),e.hasOwnProperty("start")&&(i=new Date(Date.now()-24*e.start*60*60*1e3),i.setHours(0),i.setMinutes(0),i.setSeconds(0)),e.hasOwnProperty("end")&&(r=new Date(Date.now()-24*e.end*60*60*1e3),r.setHours(23),r.setMinutes(59),r.setSeconds(59));let a=[];if((i||r)&&(this.logger.log(n,"filtering"),a=await this.searchByCreatedAt(i,r),0==a.length))return[];if(t.length>0){let e=await this.searchByTags(t);if(a=a.filter((t=>e.includes(t))),0==a.length)return[]}if(s.length>0){let e=await this.searchByTerms(s);if(a=a.filter((t=>e.includes(t))),0==a.length)return[]}let o=[];this.logger.log(n,`${a}`);for(let e=0;e<a.length;e++)o.push(await super.get(a[e]));return o}async findByIds(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.store).objectStore(this.store),r=[];i.openCursor(null,"prev").onsuccess=s=>{let i=s.target.result;i?(e.includes(i.value.id)&&r.push(i.value),i.continue()):t(r)}}))}async updateTags(e){await super.put(this.store,e),await this.updateTagIndex(e.id,e.tags)}searchByTerms(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.searchIndex).objectStore(this.searchIndex),r=[];i.openCursor().onsuccess=s=>{let i=s.target.result;i?(e.includes(i.value.term)&&(r=r.concat(i.value.queries)),i.continue()):t(r)}}))}searchByTags(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.tagIndex).objectStore(this.tagIndex),r=[];i.openCursor().onsuccess=s=>{let i=s.target.result;i?(e.includes(i.value.tag)&&(r=r.concat(i.value.queries)),i.continue()):t(r)}}))}listTags(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.tagIndex).objectStore(this.tagIndex).index(c),r=[];IDBKeyRange.lowerBound(e),i.openCursor().onsuccess=e=>{let s=e.target.result;s?(r.push(s.value.tag),s.continue()):t(r)}}))}listTerms(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.searchIndex).objectStore(this.searchIndex).index(l),r=[];IDBKeyRange.lowerBound(e),i.openCursor().onsuccess=e=>{let s=e.target.result;s?(r.push(s.value.term),s.continue()):t(r)}}))}searchByCreatedAt(e,t){return new Promise(((s,i)=>{this.logger.log(n,`s: ${e} e: ${t}`);let r,a=this.db.transaction(this.store).objectStore(this.store).index(o);if(e&&t)r=IDBKeyRange.bound(e,t);else if(e)r=IDBKeyRange.lowerBound(e);else{if(!t)return void s([]);r=IDBKeyRange.upperBound(t)}let l=[];a.openCursor(r,"prev").onsuccess=e=>{let t=e.target.result;t?(this.logger.log(n,`id: ${t.value.created_at.toISOString()}`),l.push(t.value.id),t.continue()):s(l)}}))}}class d extends a{async getDb(){let e=await super.get(parseInt(1));return null==e?"":e.db??""}async setDb(e){this.logger.log("base-meta-db","setDb");let t=await super.get(parseInt(1));null!=t?(t.db=e,await this.put(this.store,t)):await this.save(this.store,{id:parseInt(1),db:e})}async getLastSyncTs(){let t=await super.get(parseInt(1));return null==t?new Date(e.EPOCH_TIMESTAMP):t.last_sync_ts??new Date(e.EPOCH_TIMESTAMP)}async setLastSyncTs(){let e=await super.get(parseInt(1));null!=e?(e.last_sync_ts=new Date,await super.put(this.store,e)):await super.save(this.store,{id:parseInt(1),last_sync_ts:new Date})}async get(){return await super.get(parseInt(1))}async destroy(){return await super.destroy(parseInt(1))}}class u extends d{constructor(e,t){t.dbName="queries_meta",super(e,t),this.logger=e,this.store="queries_meta"}onUpgrade(e){this.logger.log("queries-meta-db",`onUpgrade: o: ${e.oldVersion} n: ${e.newVersion}`),e.oldVersion<1&&e.target.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0})}}const g="connection-db",m="connection-index";class p extends a{constructor(e,t){t.dbName="connections",super(e,t),this.logger=e,this.store="connections"}onUpgrade(t){if(this.logger.log(g,`open.onupgradeneeded: ${t.oldVersion}`),t.oldVersion<1){t.currentTarget.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0}).createIndex(m,["name","user","pass","port","db"],{unique:!0})}if(t.oldVersion<2){t.currentTarget.transaction.objectStore(this.store).createIndex(e.DB_ID_INDEX,["id","db_id"],{unique:!0})}if(t.oldVersion<3){let s=t.currentTarget.transaction.objectStore(this.store);s.deleteIndex(m),s.deleteIndex(e.DB_ID_INDEX),s.createIndex(m,["name","user","port","db"],{unique:!0}),s.createIndex(e.DB_ID_INDEX,["db_id"],{unique:!0})}if(t.oldVersion<4){let e=t.currentTarget.transaction.objectStore(this.store);e.deleteIndex(m),e.createIndex(m,["name","user","host","port","db"],{unique:!0})}}async save(e){try{if(1==e.is_default){let e=await super.getAll();for(let t=0;t<e.length;t++)await this.put(e[t].id,e[t].pass,!1)}let t=await this.search(e);return t?(await this.put(t.id,e.pass,e.is_default),t.id):await super.save(this.store,e)}catch(e){this.logger.log(g,e.message)}}async put(e,t,s){return new Promise(((i,r)=>{let a=this.db.transaction(this.store,"readwrite").objectStore(this.store),n=a.get(e);n.onsuccess=e=>{let r=e.target.result;t&&(r.pass=t),r.is_default!=s&&(r.updated_at=new Date),r.is_default=s;let n=a.put(r);n.onerror=e=>{i(e.target.error)},n.onsuccess=e=>{i(0)}},n.onerror=e=>{i(e.target.error)}}))}async search(e){return new Promise(((t,s)=>{let i=this.db.transaction(this.store).objectStore(this.store).index(m).get(IDBKeyRange.only([e.name,e.user,e.host,e.port,e.db]));i.onsuccess=e=>{t(i.result)},i.onerror=e=>{t(e.target.error)}}))}}class b extends d{constructor(e,t){t.dbName="connections_meta",super(e,t),this.logger=e,this.store="connections_meta"}onUpgrade(e){this.logger.log("connections-meta-db",`onUpgrade: o: ${e.oldVersion} n: ${e.newVersion}`),e.oldVersion<1&&e.target.result.createObjectStore(this.store,{keyPath:"id",autoIncrement:!0})}}const E="utils";class y{static saveToSession(e,t){window.sessionStorage.setItem(e,t)}static getFromSession(e){return window.sessionStorage.getItem(e)}static saveToLocalStorage(e,t){window.localStorage.setItem(e,t)}static getFromLocalStorage(e){return window.localStorage.getItem(e)??null}static processTemplate(e,t){var s=new RegExp(/{(.*?)}/g);return e=e.replace(s,(function(e,s){return t[s]||0==t[s]||""==t[s]?t[s]:e}))}static generateNode(e,t){e=y.processTemplate(e,t);let s=document.createElement("template");return s.innerHTML=e.trim(),s.content}static async get(e,t=!0,r={}){try{let t={"X-Request-ID":y.uuid()};t={...t,...r};let i=await fetch(e,{headers:t}),a=await i.json();if(s.Log(E,JSON.stringify(a)),"error"==a.status)throw a;return a}catch(e){s.Log(E,JSON.stringify(e));let r={status:"error",data:null};if(e instanceof TypeError)return t?void(window.location="/install"):(r.msg=i.ERR_NO_AGENT,r);if(r.msg=e.msg,r.msg==i.ERR_INVALID_SESSION_ID)return void(window.location="/connections");if(!t)return r;if(r.msg==i.ERR_INVALID_CURSOR_ID)return r;if(r.msg)return alert(r.msg),r}}static async post(e,t,r=!0,a={}){try{let i={"X-Request-ID":y.uuid()};i={...i,...a};let r=new FormData;for(let e in t)r.append(e,t[e]);let n=await fetch(e,{headers:i,body:r,method:"post"}),o=await n.json();if(s.Log(E,JSON.stringify(o)),"error"==o.status)throw o;return o}catch(e){s.Log(E,JSON.stringify(e));let t={status:"error",data:null};if(e instanceof TypeError)return r?void(window.location="/install"):(t.msg=i.ERR_NO_AGENT,t);if(t.msg=e.msg,t.msg==i.ERR_SIGNIN_REQUIRED)return void(window.location="/signin");if(!r)return t;if(t.msg==i.ERR_INVALID_CURSOR_ID)return t;if(t.msg)return alert(t.msg),t}}static async setOptions(e,t,s){e.replaceChildren();let i=document.getElementById("option-template").innerHTML;t.forEach((t=>{let s=y.generateNode(i,{value:t});e.append(s)})),e.value=s}static showAlert(e,t){let s=document.getElementById("alert");s.querySelector(".msg").innerHTML=e,s.style.display="block";let i=document.querySelector("body").getBoundingClientRect();s.style.left=i.width/2+"px",setTimeout((()=>{s.style.display="none"}),t)}static showNoData(){s.Log(E,"No data")}static uuid(){return"_"+Math.random().toString(36).substr(2,9)}static getOffset(e){const t=e.getBoundingClientRect();return{left:t.left+window.scrollX,top:t.top+window.scrollY,width:t.width,height:t.height}}static extractColumns(e){let t=[];return e.forEach((e=>{t.push(e[1])})),t}static truncate(e,t){return e.length>t?e.substring(0,t)+"...":e}static getTimestamp(){return(new Date).toISOString().replace(/T/," ").replace(/\..*$/,"")}static getRandomIntegerInclusive(e,t){return Math.floor(Math.random()*(t-e+1))+e}static isEmpty(e){for(var t in e)return!1;return!0}static async resetAll(){let t=new p(new s,{version:e.CONN_DB_VERSION});await t.open();let i=await t.getAll();s.Log(E,"Resetting connections..");for(let e=0;e<i.length;e++)await t.reset(i[e]);s.Log(E,"Done.");let r=new h(new s,{version:e.QUERY_DB_VERSION});await r.open();let a=await r.getAll();s.Log(E,"Resetting queries..");for(let e=0;e<a.length;e++)await r.reset(a[e]);s.Log(E,"Done."),s.Log(E,"Resetting QueriesMetaDB");let n=new u(new s,{version:e.QUERIES_META_DB_VERSION});await n.open(),await n.destroy(),s.Log(E,"Done."),s.Log(E,"Resetting connectionsMetaDb");let o=new b(new s,{version:e.CONNECTIONS_META_DB_VERSION});await o.open(),await o.destroy(),s.Log(E,"Done.")}static async delay(e){return new Promise(((t,s)=>{setTimeout((()=>{t()}),e)}))}static getTerms(e){let t=[];return sqlFormatter.format(e,{language:"mysql"}).tokens.forEach((e=>{"string"!=e.type&&"number"!=e.type?/^reserved/.test(e.type)&&t.push(e.value):t.push(e.value)})),t}}const S="stream";class w{constructor(e){this.promises=[],this.registered=!1,this.ws=new WebSocket(e),this.ws.onerror=e=>{s.Log(S,"onerror:"+e),this.rej(i.ERR_NO_AGENT)},this.ws.onclose=e=>{s.Log(S,"onclose"),this.ws=null}}get(){return new Promise(((e,t)=>{this.registered||(this.ws.onmessage=e=>{let t=this.promises.shift(),s=JSON.parse(e.data);"error"!=s.status?t(s.k):this.rej(s.msg)},this.registered=!0),this.promises.push(e),this.rej=t}))}}let f={};class ${static subscribe(e,t){f[e]||(f[e]=new Set),f[e].add(t)}static publish(e,t){let s=f[e];if(s)for(let e of s)e(t)}}let L=new class{constructor(t={}){document.addEventListener("DOMContentLoaded",(()=>{this.progressBar=document.getElementById("progress-bar-no-buttons"),this.message=this.progressBar.querySelector(".message"),this.time=this.progressBar.querySelector(".time"),this.hasButtons=!1})),$.subscribe(e.INIT_PROGRESS,(e=>{this.time.innerHTML="",this.message.innerHTML="",this.elapsed=0,this.hasButtons&&(this.title.innerHTML=e.title),this.message.innerHTML=e.message,this.timer=setInterval((()=>{this.elapsed++,this.time.innerHTML=this.elapsed+" s"}),1e3),this.progressBar.classList.add("is-active")})),$.subscribe(e.START_PROGRESS,(e=>{this.time.innerHTML="",this.message.innerHTML="",this.elapsed=0,this.hasButtons&&(this.title.innerHTML=e.title)})),$.subscribe(e.STOP_PROGRESS,(()=>{if(clearInterval(this.timer),this.ok)return this.ok.disabled=!1,void(this.cancel.disabled=!0);this.progressBar.classList.remove("is-active")})),$.subscribe(e.UPDATE_PROGRESS,(e=>{this.message.innerHTML=e.message}))}setOptions(e){e.buttons?(this.progressBar=document.getElementById("progress-bar-with-buttons"),this.title=this.progressBar.querySelector(".modal-card-title"),this.ok=this.progressBar.querySelector(".ok"),this.cancel=this.progressBar.querySelector(".cancel"),this.cancelFunc=e.cancel,this.ok.disabled=!0,this.cancel.disabled=!1,this.ok.addEventListener("click",(()=>{this.progressBar.classList.remove("is-active")})),this.cancel.addEventListener("click",(()=>{this.cancelFunc(),this.progressBar.classList.remove("is-active")})),this.hasButtons=!0):(this.ok=null,this.cancel=null,this.cancelFunc=null,this.progressBar=document.getElementById("progress-bar-no-buttons"),this.hasButtons=!1),this.message=this.progressBar.querySelector(".message"),this.time=this.progressBar.querySelector(".time")}};const I="dbutils";class R{static async fetchAll(t,i,r=!1){let a={"session-id":t,query:i},n=await y.get(e.URL+"/query?"+new URLSearchParams(a),r);if(s.Log(I,JSON.stringify(n)),"error"==n.status)throw s.Log(I,JSON.stringify(n)),n.msg;a={"session-id":t,"cursor-id":n.data["cursor-id"],"num-of-rows":e.BATCH_SIZE};let o=!1,l=[];do{if(n=await y.get(e.URL+"/fetch?"+new URLSearchParams(a),r),"error"==n.status)throw s.Log(I,JSON.stringify(n)),n.msg;if(s.Log(I,JSON.stringify(n)),!n.data)return l;l=l.concat(n.data),o=n.eof}while(!o);return l}static async login(t){let i=await y.get(e.URL+"/login?"+new URLSearchParams(t));return"error"==i.status?(s.Log(I,JSON.stringify(i)),""):i.data["session-id"]}async execute(t){this.cursorId=await R.fetchCursorId(this.sessionId,t,!0);let s={"session-id":this.sessionId,"cursor-id":this.cursorId,"num-of-rows":-1};return await y.get(e.URL+"/fetch?"+new URLSearchParams(s))}static async cancel(t,s){let i={"session-id":t,"cursor-id":s};await y.get(e.URL+"/cancel?"+new URLSearchParams(i))}static async fetchCursorId(t,s,i=!1){let r={"session-id":t,query:encodeURIComponent(s)};if(i){return(await y.get(e.URL+"/execute?"+new URLSearchParams(r))).data["cursor-id"]}return(await y.get(e.URL+"/query?"+new URLSearchParams(r))).data["cursor-id"]}async exportResults(t){let r=await R.fetchCursorId(this.sessionId,t);s.Log(I,`cursorId: ${r}`);let a={"session-id":this.sessionId,"cursor-id":r,"req-id":y.uuid(),"num-of-rows":-1,export:!0},n=new w(e.WS_URL+"/fetch_ws?"+new URLSearchParams(a));L.setOptions({buttons:!0,cancel:()=>{R.cancel(this.sessionId,r),s.Log(I,`Cancelled ${r}`)}}),$.publish(e.INIT_PROGRESS,{title:"Running query",message:"Please wait"});let o="",l=0,c=i.ERR_NONE;for(;;){let s;try{s=await n.get()}catch(t){$.publish(e.STREAM_ERROR,{error:t}),c=t;break}if(1==s.length&&"eos"==s[0])break;"header"!=s[0]?"current-row"==s[0]&&(l+=s[1],$.publish(e.UPDATE_PROGRESS,{message:`Processed ${s[1]} rows`})):(o=s[2],$.publish(e.START_PROGRESS,{title:`Exporting to ${o}`}),$.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]}))}return l>0?$.publish(e.UPDATE_PROGRESS,{message:"Export complete"}):($.publish(e.START_PROGRESS,{title:"No data"}),$.publish(e.UPDATE_PROGRESS,{message:"Processed 0 rows"})),$.publish(e.STOP_PROGRESS,{}),c==i.ERR_NONE?{status:"ok","rows-affected":l}:{status:"error",msg:c}}static createFKMap(e){s.Log(I,JSON.stringify(e));let t,i,r,a,n={};if(0==e.length)return n;let o=0;return e[0].forEach((e=>{switch(e){case"CONSTRAINT_NAME":a=o+1;break;case"COLUMN_NAME":t=o+1;break;case"REFERENCED_TABLE_NAME":i=o+1;break;case"REFERENCED_COLUMN_NAME":r=o+1}o++})),e.forEach((e=>{"NULL"!=e[i]&&(n[e[t]]={"ref-table":e[i],"ref-column":e[r]}),"PRIMARY"==e[a]&&(n["primary-key"]=e[t])})),n}static getLimit(t,s){return`${(t+s)*e.BATCH_SIZE_WS}, ${e.BATCH_SIZE_WS}`}static getOrder(e,t){return t?` order by \`${e}\` ${t}`:""}}const _="stack";class v{constructor(t){this.cb=t,this.stack=[],this.curr=0,this.$back=document.getElementById("back"),this.$back.addEventListener("click",(async()=>{this.handleCmd(e.CMD_BACK)})),[e.CMD_BACK].forEach((e=>{(e=>{$.subscribe(e,(()=>{this.handleCmd(e)}))})(e)}))}async handleBack(){s.Log(_,`${this.stack.length}: ${this.curr}`),0!=this.stack.length&&0!=this.curr&&(this.curr--,this.stack.pop(),await this.cb(this.stack[this.curr]),s.Log(_,"Done back"),0==this.curr&&this.$back.classList.add("stack-disable"))}async handleCmd(t){if(t===e.CMD_BACK)this.handleBack()}reset(){this.stack=[],this.curr=0,this.$back.classList.add("stack-disable")}push(...e){return s.Log(_,JSON.stringify(e)),1==e.length?(this.stack.push({type:"table",table:e[0]}),void s.Log(_,"table:"+JSON.stringify(this.stack))):3==e.length?(this.stack.push({type:"fk-ref",table:e[0],column:e[1],value:e[2]}),this.curr++,this.$back.classList.remove("stack-disable"),void s.Log(_,"fk-ref:"+JSON.stringify(this.stack))):4==e.length?(this.stack.push({type:"search",table:e[0],column:e[1],operator:e[2],value:e[3]}),this.curr++,this.$back.classList.remove("stack-disable"),void s.Log(_,"search:"+JSON.stringify(this.stack))):void 0}}class D{constructor(e){this.fkMap=e,this.fkCellTemplate=document.getElementById("fk-cell-template").innerHTML,this.cellTemplate=document.getElementById("cell-template").innerHTML}render(e){s.Log("cell-renderer",`${e.colDef.field}`);let t=e.colDef.colId,i=e.colDef.field,r=e.data[`${i}-${t}`],a="",n="";this.fkMap[i]&&"NULL"!=r&&(a=this.fkMap[i]["ref-table"],n=this.fkMap[i]["ref-column"]);let o="NULL"==r?"null":"";return a?y.generateNode(this.fkCellTemplate,{value:r,table:a,column:n}):y.generateNode(this.cellTemplate,{value:r,cls:o})}}class T{init(e){this.params=e,this.$header=document.createElement("div"),this.$header.innerHTML=`\n           <div class="customHeaderLabel">${this.params.displayName}</div>\n           <div class="customSortDownLabel inactive">\n               <i class="fa fa-long-arrow-alt-down"></i>\n           </div>\n           <div class="customSortUpLabel inactive">\n               <i class="fa fa-long-arrow-alt-up"></i>\n           </div>\n           <div class="customSortRemoveLabel inactive">\n               <i class="fa fa-times"></i>\n           </div>\n       `,this.$sortDown=this.$header.querySelector(".customSortDownLabel"),this.$sortUp=this.$header.querySelector(".customSortUpLabel"),this.$sortRemove=this.$header.querySelector(".customSortRemoveLabel"),this.params.enableSorting?(this.onSortAscRequestedListener=this.onSortRequested.bind(this,"asc"),this.$sortDown.addEventListener("click",this.onSortAscRequestedListener),this.onSortDescRequestedListener=this.onSortRequested.bind(this,"desc"),this.$sortUp.addEventListener("click",this.onSortDescRequestedListener),this.onRemoveSortListener=this.onSortRequested.bind(this,""),this.$sortRemove.addEventListener("click",this.onRemoveSortListener),this.onSortChangedListener=this.onSortChanged.bind(this),this.params.column.addEventListener("sortChanged",this.onSortChangedListener),this.onSortChanged()):(this.$header.removeChild(this.$sortDown),this.$header.removeChild(this.$sortUp),this.$header.removeChild(this.$sortRemove))}onSortChanged(e){const t=e=>{e.forEach((e=>{e.className=e.className.split(" ")[0]}))},s=e=>{e.className=e.className+" sort-active"};"asc"==e?(t([this.$sortUp,this.$sortRemove]),s(this.$sortDown)):"desc"==e?(t([this.$sortDown,this.$sortRemove]),s(this.$sortUp)):(t([this.$sortUp,this.$sortDown]),s(this.$sortRemove))}getGui(){return this.$header}onSortRequested(t,s){$.publish(e.SORT_REQUESTED,{column:this.params.column.colDef.field,order:t}),this.onSortChanged(t)}destroy(){this.$sortDown.removeEventListener("click",this.onSortRequestedListener),this.$sortUp.removeEventListener("click",this.onSortRequestedListener),this.$sortRemove.removeEventListener("click",this.onSortRequestedListener),this.params.column.removeEventListener("sortChanged",this.onSortChangedListener)}}const C="cell-editor";class k{init(e){let t=e.colDef.colId,i=e.colDef.field;this.value=e.data[`${i}-${t}`],this.input=document.createElement("input"),this.input.classList.add("input"),this.input.id="input",this.input.value=this.value,this.input.addEventListener("input",(e=>{this.value=e.target.value,s.Log(C,"listener:"+this.value)}))}getGui(){return this.input}getValue(){return s.Log(C,"getvalue:"+this.value),this.input.value}isCancelBeforeStart(){return!1}isCancelAfterEnd(){return!1}afterGuiAttached(){this.input.focus()}}const N="table-utils";class O{constructor(t){this.$root=t,this.$loaderTemplate=document.getElementById("table-loader-template").innerHTML,this.init(),document.addEventListener("click",(t=>{"cancel-query"==t.target.parentElement.id&&(s.Log(N,"Cancel clicked"),$.publish(e.QUERY_CANCELLED,{}))}))}async init(){await class{static init(){return new Promise(((e,t)=>{let s=document.createElement("script");s.src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js",document.head.appendChild(s);let i=document.createElement("link");i.href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css",i.type="text/css",i.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(i),i=document.createElement("link"),i.href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-alpine.css",i.type="text/css",i.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(i),s.onload=()=>{e(agGrid.Grid)}}))}}.init()}async showContents(t,s,r={},a=!1,n=!1){this.fkMap=s;let o=this.createGrid();this.showLoader();let l=0,c=i.ERR_NONE,h=Date.now();for(;;){let i;try{i=await t.get()}catch(t){$.publish(e.STREAM_ERROR,{error:t}),c=t;break}if(1==i.length&&"eos"==i[0])break;0==l&&this.setupGrid(o,i,s,r,a,n);let h={},d=0;for(let e=0;e<i.length;e+=2)h[`${i[e]}-${d}`]=i[e+1],d++;this.api.applyTransactionAsync({add:[h]}),l++}if(this.hideLoader(),0==l){let e={};new agGrid.Grid(o,e),this.api=e.api,this.api.showNoRowsOverlay()}if(this.numOfRows=l,c==i.ERR_NONE){let e=Date.now();return{status:"ok","rows-affected":this.numOfRows,"time-taken":e-h}}return{status:"error",msg:c}}createGrid(){let e=this.$root.querySelector("#grid");null!=e&&e.remove();let t=y.generateNode('<div id="grid" class="ag-theme-alpine"></div>',{});return this.$root.append(t),this.$root.querySelector("#grid")}setupGrid(e,t,s,i,r,a){let n={columnDefs:this.setupColumns(t,s,i,r),undoRedoCellEditing:!0,rowSelection:"single",onSelectionChanged:()=>{this.onSelectionChanged(s)}};a&&(n.components={agColumnHeader:T}),new agGrid.Grid(e,n),this.gridOptions=n,this.api=n.api,this.api.hideOverlay()}onSelectionChanged(t){if(y.isEmpty(t))return;const i=this.gridOptions.api.getSelectedRows();s.Log(N,"fkMap:"+JSON.stringify(t)),s.Log(N,"onSelectionChanged:"+JSON.stringify(i));for(let s in i[0])if(s==t["primary-key"]+"-"+t["primary-key-id"]){$.publish(e.ROW_SELECTED,{key:t["primary-key"],value:i[0][s]});break}}setupColumns(e,t,i,r){let a=[],n=new D(t),o=0;for(let l=0;l<e.length;l+=2){let c=i[o]??!0;e[l]==t["primary-key"]&&(t["primary-key-id"]=o),a.push({field:e[l],colId:o++,hide:!c,resizable:!0,editable:r,sortable:!0,onCellValueChanged:e=>{this.handleCellValueChanged(t,e)},cellRenderer:e=>n.render(e),cellEditor:k,valueGetter:e=>{s.Log(N,"valueGetter");let t=e.colDef.colId,i=e.colDef.field;return e.data[`${i}-${t}`]},valueSetter:e=>{s.Log(N,"valueSetter");let t=e.colDef.colId,i=e.colDef.field;return e.data[`${i}-${t}`]=e.newValue,!0}})}return a}async update(t){let s=Date.now(),r=[];for(let e=0;e<this.numOfRows;e++){let t=this.api.rowModel.rowsToDisplay[e].data;r.push(t)}this.api.applyTransactionAsync({remove:r}),this.showLoader();let a=i.ERR_NONE,n=0;for(;;){let s;try{s=await t.get()}catch(t){$.publish(e.STREAM_ERROR,{error:t}),a=t;break}if(1==s.length&&"eos"==s[0])break;let i={},r=0;for(let e=0;e<s.length;e+=2)i[`${s[e]}-${r}`]=s[e+1],r++;this.api.applyTransactionAsync({add:[i]}),n++}if(this.numOfRows=n,this.hideLoader(),a==i.ERR_NONE){let e=Date.now();return{status:"ok","rows-affected":this.numOfRows,"time-taken":e-s}}return{status:"error",msg:a}}undo(){this.undoStarted=!0,this.api.undoCellEditing()}selectColumns(e){for(let t in e)this.gridOptions.columnApi.setColumnVisible(t,e[t])}handleCellValueChanged(t,i){if(this.undoStarted)return void(this.undoStarted=!1);s.Log(N,"handleCellValueChanged");let r=t["primary-key"],a=t["primary-key-id"],n=i.data[`${r}-${a}`],o=i.colDef.colId,l=i.colDef.field,c=i.data[`${l}-${o}`];$.publish(e.CELL_EDITED,{key:{name:r,value:n},col:{name:l,value:c},cell:{rowIndex:i.node.rowIndex,colId:i.colDef.colId}})}showLoader(){let e=y.generateNode(this.$loaderTemplate,{});document.querySelector("body").append(e);let t=document.querySelector(".table-loader"),s=this.$root.getBoundingClientRect();t.style.width=s.width+"px",t.style.height=s.height+"px",t.style.left=s.left+"px",t.style.top=s.top+"px";let i=t.querySelector("button");i.style.left=s.width/2+"px",i.style.top=s.height/4+"px"}hideLoader(){document.querySelector(".table-loader").remove()}clearInfo(){this.$timeTaken.innerText="",this.$rowsAffected.innerText=""}showInfo(e,t){let s=1==t?"row":"rows";this.$timeTaken.innerText=`${e} ms`,this.$rowsAffected.innerText=`${t} ${s} affected`}}
/*!
     * hotkeys-js v3.8.7
     * A simple micro-library for defining and dispatching keyboard shortcuts. It has no dependencies.
     * 
     * Copyright (c) 2021 kenny wong <wowohoo@qq.com>
     * http://jaywcjlove.github.io/hotkeys
     * 
     * Licensed under the MIT license.
     */var A="undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().indexOf("firefox")>0;function B(e,t,s){e.addEventListener?e.addEventListener(t,s,!1):e.attachEvent&&e.attachEvent("on".concat(t),(function(){s(window.event)}))}function M(e,t){for(var s=t.slice(0,t.length-1),i=0;i<s.length;i++)s[i]=e[s[i].toLowerCase()];return s}function q(e){"string"!=typeof e&&(e="");for(var t=(e=e.replace(/\s/g,"")).split(","),s=t.lastIndexOf("");s>=0;)t[s-1]+=",",t.splice(s,1),s=t.lastIndexOf("");return t}for(var U={backspace:8,tab:9,clear:12,enter:13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,num_0:96,num_1:97,num_2:98,num_3:99,num_4:100,num_5:101,num_6:102,num_7:103,num_8:104,num_9:105,num_multiply:106,num_add:107,num_enter:108,num_subtract:109,num_decimal:110,num_divide:111,"⇪":20,",":188,".":190,"/":191,"`":192,"-":A?173:189,"=":A?61:187,";":A?59:186,"'":222,"[":219,"]":221,"\\":220},x={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},P={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},H={16:!1,18:!1,17:!1,91:!1},F={},G=1;G<20;G++)U["f".concat(G)]=111+G;var j=[],V="all",Q=[],K=function(e){return U[e.toLowerCase()]||x[e.toLowerCase()]||e.toUpperCase().charCodeAt(0)};function W(e){V=e||"all"}function J(){return V||"all"}var Y=function(e){var t=e.key,s=e.scope,i=e.method,r=e.splitKey,a=void 0===r?"+":r;q(t).forEach((function(e){var t=e.split(a),r=t.length,n=t[r-1],o="*"===n?"*":K(n);if(F[o]){s||(s=J());var l=r>1?M(x,t):[];F[o]=F[o].map((function(e){return(!i||e.method===i)&&e.scope===s&&function(e,t){for(var s=e.length>=t.length?e:t,i=e.length>=t.length?t:e,r=!0,a=0;a<s.length;a++)-1===i.indexOf(s[a])&&(r=!1);return r}(e.mods,l)?{}:e}))}}))};function X(e,t,s){var i;if(t.scope===s||"all"===t.scope){for(var r in i=t.mods.length>0,H)Object.prototype.hasOwnProperty.call(H,r)&&(!H[r]&&t.mods.indexOf(+r)>-1||H[r]&&-1===t.mods.indexOf(+r))&&(i=!1);(0!==t.mods.length||H[16]||H[18]||H[17]||H[91])&&!i&&"*"!==t.shortcut||!1===t.method(e,t)&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0))}}function Z(e){var t=F["*"],s=e.keyCode||e.which||e.charCode;if(z.filter.call(this,e)){if(93!==s&&224!==s||(s=91),-1===j.indexOf(s)&&229!==s&&j.push(s),["ctrlKey","altKey","shiftKey","metaKey"].forEach((function(t){var s=P[t];e[t]&&-1===j.indexOf(s)?j.push(s):!e[t]&&j.indexOf(s)>-1?j.splice(j.indexOf(s),1):"metaKey"===t&&e[t]&&3===j.length&&(e.ctrlKey||e.shiftKey||e.altKey||(j=j.slice(j.indexOf(s))))})),s in H){for(var i in H[s]=!0,x)x[i]===s&&(z[i]=!0);if(!t)return}for(var r in H)Object.prototype.hasOwnProperty.call(H,r)&&(H[r]=e[P[r]]);e.getModifierState&&(!e.altKey||e.ctrlKey)&&e.getModifierState("AltGraph")&&(-1===j.indexOf(17)&&j.push(17),-1===j.indexOf(18)&&j.push(18),H[17]=!0,H[18]=!0);var a=J();if(t)for(var n=0;n<t.length;n++)t[n].scope===a&&("keydown"===e.type&&t[n].keydown||"keyup"===e.type&&t[n].keyup)&&X(e,t[n],a);if(s in F)for(var o=0;o<F[s].length;o++)if(("keydown"===e.type&&F[s][o].keydown||"keyup"===e.type&&F[s][o].keyup)&&F[s][o].key){for(var l=F[s][o],c=l.splitKey,h=l.key.split(c),d=[],u=0;u<h.length;u++)d.push(K(h[u]));d.sort().join("")===j.sort().join("")&&X(e,l,a)}}}function z(e,t,s){j=[];var i=q(e),r=[],a="all",n=document,o=0,l=!1,c=!0,h="+";for(void 0===s&&"function"==typeof t&&(s=t),"[object Object]"===Object.prototype.toString.call(t)&&(t.scope&&(a=t.scope),t.element&&(n=t.element),t.keyup&&(l=t.keyup),void 0!==t.keydown&&(c=t.keydown),"string"==typeof t.splitKey&&(h=t.splitKey)),"string"==typeof t&&(a=t);o<i.length;o++)r=[],(e=i[o].split(h)).length>1&&(r=M(x,e)),(e="*"===(e=e[e.length-1])?"*":K(e))in F||(F[e]=[]),F[e].push({keyup:l,keydown:c,scope:a,mods:r,shortcut:i[o],method:s,key:i[o],splitKey:h});void 0!==n&&!function(e){return Q.indexOf(e)>-1}(n)&&window&&(Q.push(n),B(n,"keydown",(function(e){Z(e)})),B(window,"focus",(function(){j=[]})),B(n,"keyup",(function(e){Z(e),function(e){var t=e.keyCode||e.which||e.charCode,s=j.indexOf(t);if(s>=0&&j.splice(s,1),e.key&&"meta"===e.key.toLowerCase()&&j.splice(0,j.length),93!==t&&224!==t||(t=91),t in H)for(var i in H[t]=!1,x)x[i]===t&&(z[i]=!1)}(e)})))}var ee={setScope:W,getScope:J,deleteScope:function(e,t){var s,i;for(var r in e||(e=J()),F)if(Object.prototype.hasOwnProperty.call(F,r))for(s=F[r],i=0;i<s.length;)s[i].scope===e?s.splice(i,1):i++;J()===e&&W(t||"all")},getPressedKeyCodes:function(){return j.slice(0)},isPressed:function(e){return"string"==typeof e&&(e=K(e)),-1!==j.indexOf(e)},filter:function(e){var t=e.target||e.srcElement,s=t.tagName,i=!0;return!t.isContentEditable&&("INPUT"!==s&&"TEXTAREA"!==s&&"SELECT"!==s||t.readOnly)||(i=!1),i},unbind:function(e){if(e){if(Array.isArray(e))e.forEach((function(e){e.key&&Y(e)}));else if("object"==typeof e)e.key&&Y(e);else if("string"==typeof e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];var r=s[0],a=s[1];"function"==typeof r&&(a=r,r=""),Y({key:e,scope:r,method:a,splitKey:"+"})}}else Object.keys(F).forEach((function(e){return delete F[e]}))}};for(var te in ee)Object.prototype.hasOwnProperty.call(ee,te)&&(z[te]=ee[te]);if("undefined"!=typeof window){var se=window.hotkeys;z.noConflict=function(e){return e&&window.hotkeys===z&&(window.hotkeys=se),z},window.hotkeys=z}const ie="row-adder";class re{constructor(t){this.sessionId=t,this.$add=document.getElementById("add-row"),this.$dialog=document.getElementById("row-adder-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.templ=this.$dialog.querySelector("#col-input-template").innerHTML,this.$body=this.$dialog.querySelector(".modal-card-body"),this.$title=this.$dialog.querySelector(".modal-card-title"),this.$add.addEventListener("click",(()=>{null!=this.table&&null!=this.columns&&(this.$title.innerHTML=`Add new row to ${this.table}`,this.$body.replaceChildren(),s.Log(ie,this.columns),this.openDialog(),this.columns.forEach((e=>{let t=y.generateNode(this.templ,{col:e});this.$body.append(t)})))})),this.$ok.addEventListener("click",(async()=>{this.$ok.setAttribute("disabled","disabled"),this.$title.innerHTML="Inserting row ..";let t=[],i=[];if(this.$dialog.querySelectorAll("input").forEach((e=>{let s=e.value;s&&(t.push(e.dataset.col),i.push(s))})),0==i.length)return void this.closeDialog();s.Log(ie,`cols: ${t}`),s.Log(ie,`vals: ${i}`),t=t.map((e=>`\`${e}\``)).join(","),i=i.map((e=>`'${e}'`)).join(",");let r=`insert into \`${this.table}\` (${t}) values (${i})`;s.Log(ie,r);let a=new R,n=await a.execute.apply(this,[r]);if("ok"==n.status){$.publish(e.QUERY_DISPATCHED,{query:r,tags:[e.USER]});let t=n.data[0][1];return y.showAlert(`Inserted ${t} ${"1"==t?"row":"rows"}`,2e3),this.closeDialog(),void this.$ok.removeAttribute("disabled")}this.$title.innerHTML=`Add new row to ${this.table}`,this.$ok.removeAttribute("disabled")})),this.$cancel.addEventListener("click",(()=>{R.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionId(e){this.sessionId=e}init(e,t){this.table=e,this.columns=t}}const ae="row-deleter",ne="Confirm row delete";class oe{constructor(t){this.sessionId=t,this.$del=document.getElementById("del-row"),this.$dialog=document.getElementById("row-deleter-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$title=this.$dialog.querySelector(".modal-card-title"),$.subscribe(e.ROW_SELECTED,(e=>{this.handleRowSelected(e)})),this.$del.addEventListener("click",(()=>{null!=this.table&&null!=this.key&&(this.$title.innerHTML=ne,this.$body.replaceChildren(),this.$body.append(`Delete row with primary key ${this.value} ?`),this.openDialog())})),this.$ok.addEventListener("click",(async()=>{this.$ok.setAttribute("disabled","disabled"),this.$title.innerHTML="Deleting ..";let t=`delete from \`${this.table}\` where \`${this.key}\` = '${this.value}'`;s.Log(ae,t);let i=new R,r=await i.execute.apply(this,[t]);if("ok"==r.status){$.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]});let s=r.data[0][1];return y.showAlert(`Deleted ${s} ${"1"==s?"row":"rows"}`,2e3),this.reset(),this.closeDialog(),this.$ok.removeAttribute("disabled"),void $.publish(e.ROW_DELETED,{})}this.$title.innerHTML=ne,this.$ok.removeAttribute("disabled")})),this.$cancel.addEventListener("click",(()=>{R.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}handleRowSelected(e){s.Log(ae,JSON.stringify(e)),this.$del.classList.remove("fa-disabled"),this.key=e.key,this.value=e.value}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionId(e){this.sessionId=e}init(e){this.table=e,this.reset()}reset(){this.key=null,this.value=null,this.$del.classList.add("fa-disabled")}}const le="col-selector";class ce{constructor(){let t=y.getFromLocalStorage(e.COLUMN_SELECTIONS);this.selections=t?JSON.parse(t):{},this.$selCols=document.getElementById("select-cols"),this.$dialog=document.getElementById("column-selector-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.templ=this.$dialog.querySelector("#col-select-template").innerHTML,this.$body=this.$dialog.querySelectorAll(".modal-card-body")[1],this.$title=this.$dialog.querySelector(".modal-card-title"),this.$checkAll=this.$dialog.querySelector(".checkall"),this.$selCols.addEventListener("click",(()=>{if(null==this.table||null==this.columns)return void alert("No table selected");this.$title.innerHTML=`Select columns from ${this.table} to display`,this.$body.replaceChildren(),s.Log(le,this.columns);let e=this.selections[this.table]??{},t=!0;for(let s=0;s<this.columns.length;s++){let i=this.columns[s],r=y.generateNode(this.templ,{col:i}),a=e[s]??!0;a||(t=!1),r.querySelector(".checkbox").checked=a,this.$body.append(r)}this.$checkAll.checked=t,this.$dialog.classList.add("is-active")})),this.$checkAll.addEventListener("change",(()=>{let e=this.$body.querySelectorAll("input");this.$checkAll.checked?e.forEach((e=>{e.checked=!0})):e.forEach((e=>{e.checked=!1}))})),this.$ok.addEventListener("click",(async()=>{let i={},r=this.$body.querySelectorAll("input"),a=0;r.forEach((e=>{e.checked?i[a]=!0:i[a]=!1,a++})),s.Log(le,JSON.stringify(t)),$.publish(e.COLUMNS_SELECTED,{cols:i}),this.selections[this.table]=i,y.saveToLocalStorage(e.COLUMN_SELECTIONS,JSON.stringify(this.selections)),this.$dialog.classList.remove("is-active")})),this.$cancel.addEventListener("click",(()=>{this.$dialog.classList.remove("is-active")}))}init(e,t){this.table=e,this.columns=t}getSelection(e){return this.selections[e]??{}}}const he="table-info";class de{constructor(t){this.sessionId=t,this.$info=document.getElementById("table-info"),this.$dialog=document.getElementById("table-info-dialog"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$title=this.$dialog.querySelector(".modal-card-title"),this.$info.addEventListener("click",(()=>{null!=this.table&&(this.$title.innerHTML=`${this.table}`,this.$body.replaceChildren(),this.$body.innerHTML=this.createQuery,s.Log(he,this.columns),this.$dialog.classList.add("is-active"))})),this.$ok.addEventListener("click",(async()=>{this.$dialog.classList.remove("is-active")})),$.subscribe(e.TABLE_CHANGED,(e=>{this.table=e.table,this.fetchQuery()})),$.subscribe(e.TABLE_SELECTED,(e=>{this.table=e.table,this.fetchQuery()}))}async fetchQuery(){let e=await R.fetchAll(this.sessionId,`show create table \`${this.table}\``);s.Log(he,JSON.stringify(e)),this.createQuery=`<pre> ${e[0][3]} </pre>`}setSessionId(e){this.sessionId=e}}let ue=new class{constructor(){document.addEventListener("DOMContentLoaded",(async()=>{this.$next=document.getElementById("next"),this.$prev=document.getElementById("prev"),this.$next.addEventListener("click",(async t=>{this.handleCmd(e.CMD_NEXT_ROWS)})),this.$prev.addEventListener("click",(async t=>{this.handleCmd(e.CMD_PREV_ROWS)}))})),[e.CMD_NEXT_ROWS,e.CMD_PREV_ROWS].forEach((e=>{(e=>{$.subscribe(e,(()=>{this.handleCmd(e)}))})(e)}))}reset(){this.page=0,this.$prev.classList.add("pager-disable"),this.sortColumn="",this.sortOrder="",this.query=""}setQuery(e){this.query=e}setSortInfo(e,t){this.sortColumn=e,this.sortOrder=t}init(e,t,s=null,i=null){this.page=0,this.query=e,this.sortColumn=s,this.sortOrder=i,this.renderFunc=t,this.$prev.classList.add("pager-disable"),e=`${this.query} ${R.getOrder(this.sortColumn,this.sortOrder)} limit ${R.getLimit(this.page,0)}`,this.renderFunc(e)}async handleCmd(t){switch(t){case e.CMD_NEXT_ROWS:this.handleNextRows();break;case e.CMD_PREV_ROWS:this.handlePrevNows()}}async handleNextRows(){if(this.inFlight)return;this.inFlight=!0;let e=`${this.query} ${R.getOrder(this.sortColumn,this.sortOrder)} limit ${R.getLimit(this.page,1)}`;"ok"==(await this.renderFunc(e)).status&&(this.$prev.classList.remove("pager-disable"),this.page++),this.inFlight=!1}async handlePrevNows(){if(this.inFlight)return;if(this.inFlight=!0,0==this.page)return void(this.inFlight=!1);let e=`${this.query} ${R.getOrder(this.sortColumn,this.sortOrder)} limit ${R.getLimit(this.page,-1)}`;"ok"==(await this.renderFunc(e)).status&&(this.page--,0==this.page&&this.$prev.classList.add("pager-disable")),this.inFlight=!1}};const ge=["=","<>",">","<",">=","<=","LIKE","IS NULL","IS NOT NULL"],me="table-contents";class pe{constructor(e){s.Log(me,`sessionId: ${e}`),this.sessionId=e,this.init()}setSessionInfo(e,t){this.sessionId=e,this.db=t,this.rowAdder.setSessionId(this.sessionId),this.rowDeleter.setSessionId(this.sessionId),this.tableInfo.setSessionId(this.sessionId),s.Log(me,`sessionId: ${e} db: ${t}`)}async init(){(class{static init(){z(e.SHIFT_R,(()=>{$.publish(e.CMD_RUN_QUERY,{})})),z(e.SHIFT_F,(()=>{$.publish(e.CMD_FORMAT_QUERY,{})})),z(e.SHIFT_N,(()=>{$.publish(e.CMD_NEXT_ROWS,{})})),z(e.SHIFT_P,(()=>{$.publish(e.CMD_PREV_ROWS,{})})),z(e.SHIFT_E,(()=>{$.publish(e.CMD_EXPORT,{})})),z(e.SHIFT_L,(()=>{$.publish(e.CMD_EXPORT_TABLE,{})})),z(e.SHIFT_S,(()=>{$.publish(e.CMD_SEARCH_TABLES,{})})),z(e.SHIFT_BACK,(()=>{$.publish(e.CMD_BACK,{})}))}}).init(),this.rowAdder=new re(this.sessionId),this.rowDeleter=new oe(this.sessionId),this.tableInfo=new de(this.sessionId),this.colSelector=new ce,this.initDom(),this.stack=new v((async e=>{await this.navigate(e)})),this.tableUtils=new O(this.$contents),this.initSubscribers(),this.initHandlers()}initDom(){this.$columNames=document.getElementById("column-names"),this.$operators=document.getElementById("operators"),this.$searchText=document.getElementById("search-text"),this.$search=document.getElementById("search"),this.$tableContents=document.getElementById("table-contents"),this.$contents=document.getElementById("table-contents"),this.$exportFiltered=document.getElementById("export-filtered-results"),this.$clearFilter=document.getElementById("clear-filter"),this.$clearFilter=document.getElementById("clear-filter"),this.$timeTaken=document.getElementById("time-taken"),this.$rowsAffected=document.getElementById("rows-affected")}initSubscribers(){$.subscribe(e.STREAM_ERROR,(t=>{s.Log(me,`${e.STREAM_ERROR}: ${JSON.stringify(t)}`),i.handle(t)})),$.subscribe(e.QUERY_CANCELLED,(()=>{R.cancel(this.sessionId,this.cursorId)})),$.subscribe(e.SORT_REQUESTED,(e=>{this.handleSort(e)})),$.subscribe(e.COLUMNS_SELECTED,(e=>{this.handleSelectColumns(e)})),[e.ROW_DELETED,e.TABLE_TRUNCATED].forEach((e=>{(e=>{$.subscribe(e,(()=>{this.refresh()}))})(e)})),[e.CMD_RUN_QUERY,e.CMD_EXPORT,e.CMD_FORMAT_QUERY].forEach((e=>{(e=>{$.subscribe(e,(()=>{this.handleCmd(e)}))})(e)})),$.subscribe(e.CELL_EDITED,(async t=>{s.Log(me,e.CELL_EDITED),await this.handleCellEdit(t)}))}refresh(){ue.init(this.query,(async e=>await this.updateContents(e)),this.sortColumn,this.sortOrder)}async initHandlers(){this.$search.addEventListener("click",(async()=>{this.search(),this.stack.push(this.table,this.$columNames.value,this.$operators.value,this.$searchText.value)})),this.$searchText.addEventListener("keyup",(async e=>{this.$searchText.value?this.$clearFilter.style.display="block":this.$clearFilter.style.display="none","Enter"==e.key&&(this.search(),this.stack.push(this.table,this.$columNames.value,this.$operators.value,this.$searchText.value))})),this.$tableContents.addEventListener("click",(async t=>{s.Log(me,"clicked");let i=event.target;if(!i.classList.contains("fk-icon"))return;let r=i.dataset.value;s.Log(me,`${i.dataset.table}:${i.dataset.column}:${r}`),await this.showFkRef(i.dataset.table,i.dataset.column,r),$.publish(e.TABLE_CHANGED,{table:i.dataset.table}),this.stack.push(i.dataset.table,i.dataset.column,r)})),this.$operators.addEventListener("change",(()=>{"IS NULL"!=this.$operators.value&&"IS NOT NULL"!=this.$operators.value?this.$searchText.disabled=!1:this.$searchText.disabled=!0})),this.$exportFiltered.addEventListener("click",(async t=>{this.handleCmd(e.CMD_EXPORT)})),this.$clearFilter.addEventListener("click",(async t=>{this.handleCmd(e.CMD_CLEAR_FILTER)}))}async handleSort(e){s.Log(me,JSON.stringify(e)),this.sortColumn=e.column,this.sortOrder=e.order;ue.init(this.query,(async e=>await this.updateContents(e)),this.sortColumn,this.sortOrder)}async handleCellEdit(t){s.Log(me,JSON.stringify(t));let i=`update \`${this.table}\`\n                    set \`${t.col.name}\` = '${t.col.value}' \n                    where \`${t.key.name}\` = '${t.key.value}'`,r=new R,a=await r.execute.apply(this,[i]);if(this.tableUtils.showLoader(),"ok"==a.status){$.publish(e.QUERY_DISPATCHED,{query:i,tags:[e.USER]});let t=a.data[0][1];return y.showAlert(`Updated ${t} ${"1"==t?"row":"rows"}`,2e3),0==t&&this.tableUtils.undo(),void this.tableUtils.hideLoader()}this.tableUtils.hideLoader(),this.tableUtils.undo()}async showFkRef(t,s,i){await this.initTable(t),this.table=t,this.rowAdder.init(this.table,this.columns),this.colSelector.init(this.table,this.columns);let r=`select * from \`${t}\` \n                         where \`${s}\` = '${i}'`;ue.init(r,(async t=>{let s=await this.showContents(t,this.fkMap);return"ok"==s.status&&$.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]}),s}))}async search(){"IS NULL"==this.$operators.value||"IS NOT NULL"==this.$operators.value?this.query=`select * from \`${this.table}\` \n                             where \`${this.$columNames.value}\`\n                             ${this.$operators.value}`:this.query=`select * from \`${this.table}\` \n                             where \`${this.$columNames.value}\`\n                             ${this.$operators.value}\n                             '${this.$searchText.value}'`,s.Log(me,this.query);ue.init(this.query,(async t=>{let s=await this.showContents(t,this.fkMap);return"ok"==s.status&&$.publish(e.QUERY_DISPATCHED,{query:this.query,tags:[e.USER]}),s}))}reset(){this.sortColumn=null,this.sortOrder=null}async show(e){await this.initTable(e),s.Log(me,`Displaying ${e}`),this.table=e,this.rowAdder.init(this.table,this.columns),this.rowDeleter.init(this.table),this.colSelector.init(this.table,this.columns),this.stack.reset(),this.stack.push(this.table),this.query=`select * from \`${this.table}\``;s.Log(me,`${this.sortColumn}:${this.sortOrder}`),ue.init(this.query,(async e=>this.showContents(e,this.fkMap)),this.sortColumn,this.sortOrder)}async initTable(e){let t,i=R.fetchAll(this.sessionId,`show columns from \`${e}\``),r=R.fetchAll(this.sessionId,`SELECT\n                TABLE_NAME,\n                COLUMN_NAME,\n                CONSTRAINT_NAME,\n                REFERENCED_TABLE_NAME,\n                REFERENCED_COLUMN_NAME\n                FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE\n                WHERE\n                TABLE_SCHEMA = '${this.db}' and\n                TABLE_NAME = '${e}'`);try{t=await Promise.all([i,r])}catch(e){throw s.Log(me,`Error: ${e}`),e}s.Log(me,JSON.stringify(t[1])),this.fkMap=R.createFKMap(t[1]),this.columns=y.extractColumns(t[0]),y.setOptions(this.$columNames,this.columns,""),y.setOptions(this.$operators,ge,""),this.$searchText.value=""}async showContents(t,i,r=!0){this.tableUtils.clearInfo.apply(this),this.cursorId=await R.fetchCursorId(this.sessionId,t);let a={"session-id":this.sessionId,"cursor-id":this.cursorId,"req-id":y.uuid(),"num-of-rows":e.BATCH_SIZE_WS},n=new w(e.WS_URL+"/fetch_ws?"+new URLSearchParams(a)),o=this.colSelector.getSelection(this.table),l=await this.tableUtils.showContents(n,i,o,!0,!0);return s.Log(me,JSON.stringify(l)),"ok"==l.status&&this.tableUtils.showInfo.apply(this,[l["time-taken"],l["rows-affected"]]),l}async updateContents(t){this.tableUtils.clearInfo.apply(this),this.cursorId=await R.fetchCursorId(this.sessionId,t);let s={"session-id":this.sessionId,"cursor-id":this.cursorId,"req-id":y.uuid(),"num-of-rows":e.BATCH_SIZE_WS},i=new w(e.WS_URL+"/fetch_ws?"+new URLSearchParams(s)),r=await this.tableUtils.update(i);return"ok"==r.status&&this.tableUtils.showInfo.apply(this,[r["time-taken"],r["rows-affected"]]),r}async handleCmd(t){switch(t){case e.CMD_EXPORT:this.handleExport();break;case e.CMD_CLEAR_FILTER:this.handleClearFilter()}}handleSelectColumns(e){this.tableUtils.selectColumns(e.cols)}handleClearFilter(){y.setOptions(this.$columNames,this.columns,""),y.setOptions(this.$operators,ge,""),this.$searchText.value="",this.$searchText.focus(),this.$clearFilter.style.display="none",this.table&&this.show(this.table)}async handleExport(){if(!this.query)return;let t=new R;"ok"==(await t.exportResults.apply(this,[this.query])).status&&$.publish(e.QUERY_DISPATCHED,{query:this.query,tags:[e.USER]})}async navigate(t){switch(s.Log(me,JSON.stringify(t)),$.publish(e.TABLE_CHANGED,{table:t.table}),t.type){case"table":await this.show(t.table);break;case"fk-ref":await this.showFkRef(t.table,t.column,t.value);break;case"search":await this.initTable(t.table),this.table=t.table,this.$columNames.value=t.column,this.$operators.value=t.operator,this.$searchText.value=t.value,await this.search()}s.Log(me,"Done navigate")}}const be="modules-tables";class Ee{constructor(t){this.$root=document.getElementById("app-left-panel"),this.sessionId=t,this.$tables=document.getElementById("tables"),this.$tableFilter=document.getElementById("table-filter"),this.$exportTable=document.getElementById("export-table"),this.$tableFilter.addEventListener("keyup",(()=>{this.filter()})),this.$exportTable.addEventListener("click",(()=>{this.handleCmd(e.CMD_EXPORT_TABLE)})),this.$tables.addEventListener("click",(async t=>{let s=t.target;"table-name"==s.className&&(this.$tables.querySelectorAll(".highlight").forEach((e=>{e.classList.remove("highlight")})),s.parentElement.classList.add("highlight"),this.table=s.innerHTML,$.publish(e.TABLE_SELECTED,{table:s.innerHTML}))})),$.subscribe(e.TABLE_CHANGED,(e=>{let t=this.$tables.querySelectorAll(".highlight");t.forEach((e=>{e.classList.remove("highlight")})),t=this.$tables.querySelectorAll(".table-name");for(let s=0;s<t.length;s++)if(t[s].innerHTML==e.table){t[s].parentElement.classList.add("highlight");break}})),$.subscribe(e.TABLE_RENAMED,(()=>{this.show()})),s.Log(be,`sessionId: ${t}`),[e.CMD_EXPORT_TABLE,e.CMD_SEARCH_TABLES].forEach((e=>{(e=>{$.subscribe(e,(()=>{this.handleCmd(e)}))})(e)}))}async handleCmd(t){switch(t){case e.CMD_EXPORT_TABLE:this.handleExportTable();break;case e.CMD_SEARCH_TABLES:this.$tableFilter.focus()}}async handleExportTable(){if(!this.table)return void alert("No table selected");let e=`select * from \`${this.table}\``;(new R).exportResults.apply(this,[e])}setSessionInfo(e,t){this.sessionId=e,this.db=t,s.Log(be,`sessionId: ${e} db: ${t}`)}filter(){let e=this.$tableFilter.value;if(""==e)return void this.render(this.tables);s.Log(be,`Filtering ${e}`);let t=new RegExp(`${e}`),i=this.tables.filter((e=>t.test(e)));this.render(i)}async show(t=null){s.Log(be,"show");let i=`show tables from \`${t=t??this.db}\``,r=await R.fetchCursorId(this.sessionId,i),a={"session-id":this.sessionId,"cursor-id":r,"req-id":y.uuid(),"num-of-rows":-1},n=new w(e.WS_URL+"/fetch_ws?"+new URLSearchParams(a));this.$tables.replaceChildren();let o=document.getElementById("table-template").innerHTML;for(this.tables=[];;){let e=await n.get();if(1==e.length&&"eos"==e[0])break;let t=y.generateNode(o,{table:e[1]});this.$tables.append(t),this.tables.push(e[1])}}render(e){this.$tables.replaceChildren();let t=document.getElementById("table-template").innerHTML;e.forEach((e=>{let s=y.generateNode(t,{table:e});this.$tables.append(s)}))}}const ye="grid-resizer";class Se{constructor(t,i,r,a){this.d1=i.getBoundingClientRect().width,this.d2=a.getBoundingClientRect().width,s.Log(ye,`${this.d1} ${this.d2}`),r.addEventListener("mousedown",(e=>{this.isDragging=!0,this.startx=e.clientX,s.Log(ye,`mousedown: ${e.clientX}`),e.preventDefault()})),document.addEventListener("mousemove",(e=>{if(!this.isDragging)return;s.Log(ye,`mousemove: ${e.clientX}`);let i=e.clientX-this.startx;this.d1+=i,this.d2+=-1*i,s.Log(ye,`${i} ${this.d1} ${this.d2}`),t.style.gridTemplateColumns=`${this.d1}px 2px ${this.d2}px`,this.startx=e.clientX,e.preventDefault()})),document.addEventListener("mouseup",(t=>{this.isDragging=!1,s.Log(ye,`mouseup: ${t.clientX}`),t.preventDefault(),$.publish(e.GRID_H_RESIZED,{})}))}}class we{static init(){document.querySelectorAll('[id$="-menu"]').forEach((e=>{e.addEventListener("click",(e=>{s.Log("main-menu",`${e.currentTarget.id} clicked `),we.handleMenu(e.currentTarget.id)}))}))}static handleMenu(e){switch(e){case"query-menu":window.location="/app/queries";break;case"content-menu":window.location="/app/tables";break;case"help-menu":window.location="/app/help";break;case"about-menu":window.location="/app/about"}}}const fe="db-renamer";class $e{constructor(t){this.sessionId=t,this.$dialog=document.getElementById("db-renamer-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$title=this.$dialog.querySelector(".modal-card-title"),this.$name=this.$dialog.querySelector("#new-db-name"),this.$ok.addEventListener("click",(async()=>{this.closeDialog(),L.setOptions({}),$.publish(e.INIT_PROGRESS,{}),$.publish(e.START_PROGRESS,{});try{let t=await this.getCurrentDbAttribs();$.publish(e.UPDATE_PROGRESS,{message:`Renaming ${this.db} to ${this.$name.value}`}),s.Log(fe,`Renaming ${this.db} to ${this.$name.value}`),await this.createNewDb(this.$name.value,t),s.Log(fe,"Created new DB"),$.publish(e.UPDATE_PROGRESS,{message:`Created ${this.$name.value}`}),await this.renameTables(this.db,this.$name.value),s.Log(fe,"Renamed tables"),$.publish(e.UPDATE_PROGRESS,{message:"Renamed tables"}),$.publish(e.DB_RENAMED,{"new-db":this.$name.value})}catch(e){s.Log(fe,"Error: "+e)}finally{$.publish(e.STOP_PROGRESS,{})}})),this.$cancel.addEventListener("click",(()=>{R.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}async getCurrentDbAttribs(){let e=await R.fetchAll(this.sessionId,`SELECT default_character_set_name, default_collation_name FROM information_schema.SCHEMATA\n            WHERE schema_name = "${this.db}"`);return{charset:e[0][1],collation:e[0][3]}}async renameTables(t,i){let r=await R.fetchAll(this.sessionId,`show tables from \`${t}\``),a=new R;for(let n=0;n<r.length;n++){s.Log(fe,r[n][1]);let o=r[n][1],l=`rename table \`${t}\`.\`${o}\` to \`${i}\`.\`${o}\``,c=await a.execute.apply(this,[l]);if("ok"!=c.status)throw`${c.msg}`;$.publish(e.UPDATE_PROGRESS,{message:`Renamed ${o}`})}}async createNewDb(e,t){let s=`create database if not exists \`${e}\` \n            character set ${t.charset} collate ${t.collation}`,i=new R,r=await i.execute.apply(this,[s]);if("ok"!=r.status)throw`${r.msg}`}async deleteOldDb(e){let t=`drop database \`${e}\``,s=new R,i=await s.execute.apply(this,[t]);if("ok"!=i.status)throw`${i.msg}`}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionInfo(e,t){this.sessionId=e,this.db=t}init(e){this.db=e,this.title=`Rename ${this.db} to:`,this.$title.innerHTML=this.title,this.$name.value="",this.openDialog()}reset(){}}class Le{constructor(t){this.sessionId=t,this.$dialog=document.getElementById("db-deleter-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$body.innerHTML="This operation will delete the database. Are you sure?",this.$title=this.$dialog.querySelector(".modal-card-title"),this.$ok.addEventListener("click",(async()=>{this.$ok.setAttribute("disabled","disabled"),this.$title.innerHTML=`Deleting ${this.db}..`;let t=`drop database \`${this.db}\``;s.Log("db-deleter",t);let i=new R,r=await i.execute.apply(this,[t]);if("ok"==r.status)return $.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]}),r.data[0][1],y.showAlert(`Deleted database ${this.db}`,2e3),this.closeDialog(),this.$ok.removeAttribute("disabled"),void $.publish(e.DB_DELETED,{});this.$title.innerHTML=this.title,this.$ok.removeAttribute("disabled")})),this.$cancel.addEventListener("click",(()=>{R.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionInfo(e,t){this.sessionId=e,this.db=t}init(e){this.db=e,this.title=`Delete ${this.db}?`,this.$title.innerHTML=this.title,this.openDialog()}}const Ie="db-menu";class Re{constructor(e,t){s.Log(Ie,`sessionId: ${e}`),this.sessionId=e,this.db=t,this.init()}setSessionInfo(e,t){this.sessionId=e,this.db=t,this.renamer.setSessionInfo(this.sessionId,this.db),this.deleter.setSessionInfo(this.sessionId,this.db),s.Log(Ie,`sessionId: ${e} db: ${t}`)}init(){this.initDom(),this.initHandlers(),this.renamer=new $e(this.sessionId),this.deleter=new Le(this.sessionId)}initDom(){this.$dbMenu=document.getElementById("db-operations")}initHandlers(){this.$dbMenu.addEventListener("click",(()=>{if(!this.db)return void alert("No database selected");this.$dbMenu.parentNode.parentNode.classList.toggle("is-active")})),document.querySelectorAll('[class~="db-dropdown-item"]').forEach((e=>{e.addEventListener("click",(e=>{this.$dbMenu.parentNode.parentNode.classList.toggle("is-active"),this.handleMenu(e.currentTarget.id)}))}))}handleMenu(e){switch(s.Log(Ie,`id: ${e}`),e){case"rename-db":this.renamer.init(this.db);break;case"delete-db":this.deleter.init(this.db)}}}const _e="appbar";class ve{constructor(t,i,r){this.sessionId=i,this.db=r,this.dbMenu=new Re(this.sessionId,this.db),this.$databases=document.getElementById("databases"),document.getElementById("conn-name").innerHTML=`${t}&nbsp;&nbsp;&nbsp;`,this.showDatabases(),this.$databases.addEventListener("change",(()=>{this.db=this.$databases.value,s.Log(_e,"Db changed to "+this.db),this.dbMenu.setSessionInfo(this.sessionId,this.db),$.publish(e.DB_CHANGED,{db:this.db})})),$.subscribe(e.DB_RENAMED,(async e=>{s.Log(_e,"Db renamed"),this.db=e["new-db"],await this.showDatabases(),this.$databases.dispatchEvent(new Event("change"))})),$.subscribe(e.DB_DELETED,(async e=>{s.Log(_e,"Db deleted"),this.db="",await this.showDatabases(),this.$databases.dispatchEvent(new Event("change"))}))}async showDatabases(){let e=await R.fetchAll(this.sessionId,"show databases");e=y.extractColumns(e),y.setOptions(this.$databases,e,this.db)}setSessionInfo(e){this.sessionId=e}}const De="file-uploader";class Te{constructor(){this.mID="fu-"+y.uuid();let t=document.getElementById("file-upload-template").innerHTML,i=y.generateNode(t,{"fu-id":this.mID});document.querySelector("body").append(i),document.querySelector("[type=file]").addEventListener("change",(t=>{if(s.Log(De,"changed"),t.target.files.length>0){let s=new FileReader;s.readAsText(t.target.files[0]),s.addEventListener("load",(()=>{try{let t=JSON.parse(s.result);$.publish(e.FILE_UPLOADED,t)}catch(e){return void alert(e)}finally{document.querySelector(`#${this.mID}`).remove()}}))}}))}show(){s.Log(De,"Showing "+this.mID),document.querySelector("[type=file]").click()}}const Ce="query-history";class ke{constructor(){$.subscribe(e.QUERY_DISPATCHED,(async t=>{s.Log(Ce,JSON.stringify(t)),this.queryDb||await this.init(),t.terms=y.getTerms(t.query);let i=await this.queryDb.save(t);s.Log(Ce,`Saved to ${i}`),$.publish(e.QUERY_SAVED,{id:i})})),$.subscribe(e.FILE_UPLOADED,(async e=>{await this.handleUpload(e)}));let t=document.getElementById("download-history");t&&(t.addEventListener("click",(async()=>{await this.handleDownload()})),document.getElementById("import-file").addEventListener("click",(async()=>{(new Te).show()})))}async init(){this.queryDb=new h(new s,{version:e.QUERY_DB_VERSION}),await this.queryDb.open()}async handleDownload(){let e=await this.queryDb.filter({start:1e4,end:0},[],[]);for(let t=0;t<e.length;t++){let s=e[t],i=s.created_at.getFullYear(),r=s.created_at.getMonth(),a=s.created_at.getDate(),n=s.created_at.getHours(),o=s.created_at.getMinutes(),l=s.created_at.getSeconds();e[t].year=i,e[t].month=r,e[t].date=a,e[t].hours=n,e[t].minutes=o,e[t].seconds=l,delete e[t].created_at}(class{static download(e,t,s,i){var r=new Blob(void 0!==i?[i,e]:[e],{type:s||"application/octet-stream"});if(void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(r,t);else{var a=window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(r):window.webkitURL.createObjectURL(r),n=document.createElement("a");n.style.display="none",n.href=a,n.setAttribute("download",t),void 0===n.download&&n.setAttribute("target","_blank"),document.body.appendChild(n),n.click(),setTimeout((function(){document.body.removeChild(n),window.URL.revokeObjectURL(a)}),200)}}}).download(JSON.stringify(e),"data.json","application/json")}async handleUpload(t){L.setOptions({}),$.publish(e.INIT_PROGRESS,{}),$.publish(e.START_PROGRESS,{});for(let i=0;i<t.length;i++){let r=t[i];r.id&&delete r.id;let a=new Date;a.setFullYear(r.year),a.setMonth(r.month),a.setDate(r.date),a.setHours(r.hours),a.setMinutes(r.minutes),a.setSeconds(r.seconds),delete r.year,delete r.month,delete r.date,delete r.hours,delete r.minutes,delete r.seconds,r.created_at=a,r.terms=y.getTerms(r.query);let n=await this.queryDb.save(r);$.publish(e.UPDATE_PROGRESS,{message:`Imported ${i+1} of ${t.length}`}),s.Log(Ce,`Saved to ${n}`)}$.publish(e.STOP_PROGRESS,{})}}class Ne{constructor(){this.$version=document.getElementById("version"),s.Log("workers",`ver: ${this.$version.value}`)}async initDb(){this.queryDb=new h(new s,{version:e.QUERY_DB_VERSION}),await this.queryDb.open()}initConnectionWorker(){this.connectionWorker=new SharedWorker(`/build-0.6/dist/js/connection-worker.js?ver=${this.$version.value}`),this.connectionWorker.port.onmessage=t=>{switch(t.data.type){case e.DEBUG_LOG:s.Log("connection-worker",t.data.payload);break;case e.NEW_CONNECTIONS:$.publish(e.NEW_CONNECTIONS,{})}}}async initQueryWorker(){await this.initDb(),this.queryWorker=new SharedWorker(`/build-0.6/dist/js/query-worker.js?ver=${this.$version.value}`),this.queryWorker.port.onmessage=async t=>{switch(t.data.type){case e.DEBUG_LOG:s.Log("query-worker",t.data.payload);break;case e.NEW_QUERIES:$.publish(e.NEW_QUERIES,{});break;case e.EXECUTE_SAVE_REC:s.Log("query-worker",e.EXECUTE_SAVE_REC);let i=t.data.data;i.terms=y.getTerms(i.query);let r=await this.queryDb.save(i);this.queryWorker.port.postMessage({type:e.EXECUTE_SUCCESS,data:r})}}}}class Oe{constructor(t){this.sessionId=t,this.$dialog=document.getElementById("table-renamer-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$title=this.$dialog.querySelector(".modal-card-title"),this.$name=this.$dialog.querySelector("#new-table-name"),this.$ok.addEventListener("click",(async()=>{this.$ok.setAttribute("disabled","disabled"),this.$title.innerHTML="Renaming ..";let t=`rename table \`${this.table}\` to \`${this.$name.value}\``;s.Log("table-renamer",t);let i=new R,r=await i.execute.apply(this,[t]);if("ok"==r.status)return $.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]}),r.data[0][1],y.showAlert("Renamed table",2e3),this.reset(),this.closeDialog(),this.$ok.removeAttribute("disabled"),void $.publish(e.TABLE_RENAMED,{});this.$title.innerHTML=this.title,this.$ok.removeAttribute("disabled")})),this.$cancel.addEventListener("click",(()=>{R.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionId(e){this.sessionId=e}init(e){this.table=e,this.title=`Rename ${this.table} to:`,this.$title.innerHTML=this.title,this.$name.value="",this.openDialog()}reset(){}}class Ae{constructor(t){this.sessionId=t,this.$dialog=document.getElementById("table-truncater-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$body.innerHTML="This operation will delete all rows from the table. Are you sure?",this.$title=this.$dialog.querySelector(".modal-card-title"),this.$ok.addEventListener("click",(async()=>{this.$ok.setAttribute("disabled","disabled"),this.$title.innerHTML="Truncating ..";let t=`truncate table \`${this.table}\``;s.Log("table-truncater",t);let i=new R,r=await i.execute.apply(this,[t]);if("ok"==r.status)return $.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]}),r.data[0][1],y.showAlert("Truncated table",2e3),this.closeDialog(),this.$ok.removeAttribute("disabled"),void $.publish(e.TABLE_TRUNCATED,{});this.$title.innerHTML=this.title,this.$ok.removeAttribute("disabled")})),this.$cancel.addEventListener("click",(()=>{R.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionId(e){this.sessionId=e}init(e){this.table=e,this.title=`Truncate ${this.table}?`,this.$title.innerHTML=this.title,this.openDialog()}}class Be{constructor(t){this.sessionId=t,this.$dialog=document.getElementById("table-deleter-dialog"),this.$cancel=this.$dialog.querySelector(".cancel"),this.$ok=this.$dialog.querySelector(".ok"),this.$body=this.$dialog.querySelector(".modal-card-body"),this.$body.innerHTML="This operation will delete the table. Are you sure?",this.$title=this.$dialog.querySelector(".modal-card-title"),this.$ok.addEventListener("click",(async()=>{this.$ok.setAttribute("disabled","disabled"),this.$title.innerHTML=`Deleting ${this.table}..`;let t=`drop table \`${this.table}\``;s.Log("table-deleter",t);let i=new R,r=await i.execute.apply(this,[t]);if("ok"==r.status)return $.publish(e.QUERY_DISPATCHED,{query:t,tags:[e.USER]}),r.data[0][1],y.showAlert(`Deleted table ${this.table}`,2e3),this.closeDialog(),this.$ok.removeAttribute("disabled"),void $.publish(e.TABLE_RENAMED,{});this.$title.innerHTML=this.title,this.$ok.removeAttribute("disabled")})),this.$cancel.addEventListener("click",(()=>{R.cancel(this.sessionId,this.cursorId),this.closeDialog()}))}openDialog(){this.$dialog.classList.add("is-active")}closeDialog(){this.$dialog.classList.remove("is-active")}setSessionId(e){this.sessionId=e}init(e){this.table=e,this.title=`Delete ${this.table}?`,this.$title.innerHTML=this.title,this.openDialog()}}const Me="ops-menu";class qe{constructor(e){s.Log(Me,`sessionId: ${e}`),this.table=null,this.sessionId=e,this.init()}setSessionInfo(e,t){this.sessionId=e,this.db=t,this.renamer.setSessionId(this.sessionId),this.truncater.setSessionId(this.sessionId),this.deleter.setSessionId(this.sessionId),s.Log(Me,`sessionId: ${e} db: ${t}`)}init(){this.initDom(),this.initHandlers(),this.initSubscribers(),this.renamer=new Oe(this.sessionId),this.truncater=new Ae(this.sessionId),this.deleter=new Be(this.sessionId)}initDom(){this.$opsMenu=document.getElementById("table-operations"),this.$renameTable=document.getElementById("rename-table")}initHandlers(){this.$opsMenu.addEventListener("click",(()=>{if(null==this.table)return void alert("No table selected");this.$opsMenu.parentNode.parentNode.classList.toggle("is-active")})),document.querySelectorAll('[class="dropdown-item"]').forEach((e=>{e.addEventListener("click",(e=>{this.$opsMenu.parentNode.parentNode.classList.toggle("is-active"),this.handleMenu(e.currentTarget.id)}))}))}handleMenu(e){switch(e){case"rename-table":this.renamer.init(this.table);break;case"truncate-table":this.truncater.init(this.table);break;case"delete-table":this.deleter.init(this.table)}}initSubscribers(){$.subscribe(e.TABLE_SELECTED,(e=>{this.table=e.table}))}}const Ue="tables";new class{constructor(){document.addEventListener("DOMContentLoaded",(async()=>{this.adjustView(),this.init()}))}async initHandlers(){$.subscribe(e.DB_CHANGED,(async t=>{s.Log(Ue,"Db changed"),this.creds.db=t.db,y.saveToSession(e.CREDS,JSON.stringify(this.creds)),this.sessionId=await R.login(this.creds),this.setSessionInfo(),this.tables.show(this.creds.db)})),this.$tables=document.getElementById("tables"),$.subscribe(e.TABLE_SELECTED,(e=>{this.tableContents.reset(),this.tableContents.show(e.table)}))}setSessionInfo(){this.tableContents.setSessionInfo(this.sessionId,this.creds.db),this.tables.setSessionInfo(this.sessionId,this.creds.db),this.opsMenu.setSessionInfo(this.sessionId,this.creds.db),this.appbar.setSessionInfo(this.sessionId)}async init(){we.init(),this.history=new ke;let t=y.getFromSession(e.CREDS);if(!t)return void(window.location="/connections");s.Log(Ue,JSON.stringify(t)),this.creds=JSON.parse(t),this.sessionId=await R.login(this.creds),s.Log(Ue,this.sessionId),this.tableContents=new pe(this.sessionId),this.tables=new Ee(this.sessionId),this.opsMenu=new qe(this.sessionId),this.appbar=new ve(this.creds.name,this.sessionId,this.creds.db),this.initHandlers(),this.creds.db&&(this.setSessionInfo(),this.tables.show(this.creds.db));let i=document.getElementById("app-content"),r=document.getElementById("app-left-panel-container"),a=document.getElementById("app-right-panel"),n=document.getElementById("app-content-resizer");new Se(i,r,n,a),$.subscribe(e.SIGNIN_REQUIRED,(async()=>{window.location="/signin"})),this.workers=new Ne,this.workers.initQueryWorker(),this.workers.initConnectionWorker(),$.subscribe(e.QUERY_SAVED,(async()=>{this.workers.queryWorker.port.postMessage({type:e.QUERY_SAVED})}))}adjustView(){let e=document.querySelector("body").getBoundingClientRect(),t=document.querySelector("#appbar").getBoundingClientRect();document.querySelector("#app-left-panel").style.height=e.height-t.height+"px",document.getElementById("app-right-panel").style.height=e.height-t.height+"px"}}}();
